<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Outstanding Invoice Management System</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,112C1248,107,1344,117,1392,122.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat;
      background-size: cover;
      opacity: 0.3;
      pointer-events: none;
    }

    /* Login Screen Styles */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      animation: fadeIn 0.5s ease;
    }

    .login-card {
      background: rgba(255,255,255,0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 450px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
      animation: slideInUp 0.5s ease;
    }

    .login-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
      background-size: 200% 100%;
      animation: shimmer 3s infinite;
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-header h1 {
      color: #4a5568;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .login-header p {
      color: #718096;
      font-size: 16px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 15px 20px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      outline: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      background: #f7fafc;
    }

    .form-group input:focus {
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .login-button {
      width: 100%;
      padding: 15px 25px;
      font-size: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }

    .login-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: #fff5f5;
      border-left: 4px solid #e53e3e;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      color: #742a2a;
      font-weight: 600;
      display: none;
      animation: shake 0.5s ease;
    }

    .loading-indicator {
      display: none;
      text-align: center;
      margin-top: 15px;
    }

    .loading-indicator i {
      font-size: 18px;
      color: #667eea;
      animation: spin 1s linear infinite;
    }

    /* Main Application Styles (hidden until login) */
    .main-app {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .main-app.logged-in {
      display: block;
    }

    .logout-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .logout-button {
      padding: 10px 20px;
      background: rgba(255,255,255,0.9);
      color: #764ba2;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .logout-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: white;
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 32px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      animation: fadeInDown 0.8s ease;
    }

    h2 {
      text-align: center;
      color: rgba(255,255,255,0.9);
      margin-bottom: 30px;
      font-weight: 400;
      font-size: 18px;
      animation: fadeInUp 0.8s ease 0.2s both;
    }

    .as-of-date {
      text-align: center;
      font-size: 16px;
      color: rgba(255,255,255,0.85);
      margin-bottom: 30px;
      font-weight: 600;
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 25px;
      display: inline-block;
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.8s ease 0.4s both;
    }

    .search-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
      animation: fadeInUp 0.8s ease 0.6s both;
    }

    .search-box {
      background: rgba(255,255,255,0.95);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      text-align: center;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }

    .search-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
      background-size: 200% 100%;
      animation: shimmer 3s infinite;
    }

    .search-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }

    .search-box h3 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .search-box h3 i {
      color: #667eea;
      font-size: 20px;
    }

    .search-box input[type="text"],
    .search-box input[type="month"] {
      width: 100%;
      padding: 15px 20px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      outline: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      transition: all 0.3s ease;
      background: #f7fafc;
    }

    .search-box input:focus {
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .search-box button {
      width: 100%;
      padding: 15px 25px;
      font-size: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .search-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }

    .search-box button i {
      font-size: 18px;
    }

    #results {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      margin-top: 20px;
      animation: fadeInUp 0.5s ease;
      border: 1px solid rgba(255,255,255,0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    th, td {
      border: 1px solid #e2e8f0;
      padding: 15px;
      text-align: left;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:nth-child(even) {
      background-color: #f8fafc;
    }

    tr:hover {
      background-color: #edf2f7;
      transition: background-color 0.2s ease;
    }

    td.amount { 
      text-align: right; 
      font-family: 'Courier New', Courier, monospace;
      font-weight: 600;
    }

    td.payment { 
      color: #38a169; 
      font-weight: 600;
    }

    td.overdue {
      text-align: center;
      font-weight: 600;
      color: #e53e3e;
      background-color: #fed7d7;
      width: 80px;
    }

    td.overdue.days-0-30 {
      color: #38a169;
      background-color: #c6f6d5;
    }

    td.overdue.days-31-60 {
      color: #d69e2e;
      background-color: #faf089;
    }

    td.overdue.days-61-90 {
      color: #dd6b20;
      background-color: #fbd38d;
    }

    td.overdue.days-91-plus {
      color: #e53e3e;
      background-color: #fed7d7;
    }

    .section-title {
      margin-top: 40px;
      font-size: 24px;
      font-weight: 700;
      color: #4a5568;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .section-title::before {
      content: '';
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .site-code-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
    }

    .not-found {
      text-align: center;
      font-weight: 700;
      color: #e53e3e;
      margin-top: 30px;
      font-size: 18px;
      background: #fed7d7;
      padding: 20px;
      border-radius: 12px;
      animation: pulse 2s infinite;
    }

    .grand-total {
      margin-top: 30px;
      text-align: right;
      font-size: 22px;
      font-weight: 700;
      color: #4a5568;
      background: linear-gradient(135deg, #f6f9fc 0%, #e9ecef 100%);
      padding: 20px;
      border-radius: 12px;
      border-left: 5px solid #667eea;
    }

    .download-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .download-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px 25px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
      min-width: 200px;
    }

    .download-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }

    .download-button.excel {
      background: linear-gradient(135deg, #107c41 0%, #0e5e2e 100%);
      box-shadow: 0 4px 15px rgba(16,124,65,0.3);
    }

    .download-button.excel:hover {
      box-shadow: 0 6px 20px rgba(16,124,65,0.4);
    }

    .download-button.secondary {
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      box-shadow: 0 4px 15px rgba(108,117,125,0.3);
    }

    .download-button.secondary:hover {
      box-shadow: 0 6px 20px rgba(108,117,125,0.4);
    }

    .download-button.secondary.excel {
      background: linear-gradient(135deg, #6f8a52 0%, #5a6e42 100%);
      box-shadow: 0 4px 15px rgba(111,138,82,0.3);
    }

    .download-button.secondary.excel:hover {
      box-shadow: 0 6px 20px rgba(111,138,82,0.4);
    }

    a.site-link {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 6px;
      transition: all 0.2s ease;
      cursor: pointer;
      display: inline-block;
    }

    a.site-link:hover {
      background: rgba(102,126,234,0.1);
      color: #764ba2;
    }

    /* New styles for invoice breakdown modal */
    .invoice-link {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 6px;
      transition: all 0.2s ease;
      cursor: pointer;
      display: inline-block;
    }

    .invoice-link:hover {
      background: rgba(102,126,234,0.1);
      color: #764ba2;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 0;
      border-radius: 20px;
      width: 80%;
      max-width: 800px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalFadeIn 0.4s;
      overflow: hidden;
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 15px; /* Reduced from 20px 30px */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px; /* Reduced from 22px */
      font-weight: 600;
    }

    .close {
      color: white;
      font-size: 22px; /* Reduced from 28px */
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      background: none;
      border: none;
    }

    .close:hover {
      opacity: 0.8;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 15px; /* Reduced from 30px */
    }

    .invoice-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px; /* Reduced from 20px */
      margin-bottom: 15px; /* Reduced from 30px */
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 5px;
      font-size: 12px; /* Reduced from 14px */
    }

    .detail-value {
      color: #2d3748;
      font-size: 14px; /* Reduced from 16px */
    }

    .outstanding-amount {
      background: linear-gradient(135deg, #f6f9fc 0%, #e9ecef 100%);
      border-left: 4px solid #667eea;
      padding: 12px;
      margin-top: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .outstanding-amount .label {
      font-size: 12px;
      color: #4a5568;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .outstanding-amount .value {
      font-size: 18px;
      color: #667eea;
      font-weight: 700;
      font-family: 'Courier New', Courier, monospace;
    }

    .summary-totals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .summary-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
      position: relative;
      overflow: hidden;
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
    }

    .summary-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.15);
    }

    .summary-card h3 {
      margin: 0 0 15px 0;
      color: #4a5568;
      font-size: 16px;
      font-weight: 600;
    }

    .summary-card .amount-big {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
      font-family: 'Courier New', Courier, monospace;
    }

    .age-summary-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
      position: relative;
      overflow: hidden;
    }

    .age-summary-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.15);
    }

    .age-summary-card h3 {
      margin: 0 0 15px 0;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .age-summary-card .amount-big {
      font-size: 22px;
      font-weight: 700;
      font-family: 'Courier New', Courier, monospace;
    }

    .age-summary-card .percentage {
      font-size: 14px;
      font-weight: 600;
      margin-top: 5px;
    }

    .age-summary-card.days-0-30 {
      border-top: 4px solid #38a169;
    }

    .age-summary-card.days-0-30 h3 {
      color: #38a169;
    }

    .age-summary-card.days-0-30 .amount-big {
      color: #38a169;
    }

    .age-summary-card.days-0-30 .percentage {
      color: #38a169;
    }

    .age-summary-card.days-31-60 {
      border-top: 4px solid #d69e2e;
    }

    .age-summary-card.days-31-60 h3 {
      color: #d69e2e;
    }

    .age-summary-card.days-31-60 .amount-big {
      color: #d69e2e;
    }

    .age-summary-card.days-31-60 .percentage {
      color: #d69e2e;
    }

    .age-summary-card.days-61-90 {
      border-top: 4px solid #dd6b20;
    }

    .age-summary-card.days-61-90 h3 {
      color: #dd6b20;
    }

    .age-summary-card.days-61-90 .amount-big {
      color: #dd6b20;
    }

    .age-summary-card.days-61-90 .percentage {
      color: #dd6b20;
    }

    .age-summary-card.days-91-180 {
      border-top: 4px solid #e53e3e;
    }

    .age-summary-card.days-91-180 h3 {
      color: #e53e3e;
    }

    .age-summary-card.days-91-180 .amount-big {
      color: #e53e3e;
    }

    .age-summary-card.days-91-180 .percentage {
      color: #e53e3e;
    }

    .age-summary-card.days-181-360 {
      border-top: 4px solid #9f1239;
    }

    .age-summary-card.days-181-360 h3 {
      color: #9f1239;
    }

    .age-summary-card.days-181-360 .amount-big {
      color: #9f1239;
    }

    .age-summary-card.days-181-360 .percentage {
      color: #9f1239;
    }

    .age-summary-card.days-360-plus {
      border-top: 4px solid #7c2d12;
    }

    .age-summary-card.days-360-plus h3 {
      color: #7c2d12;
    }

    .age-summary-card.days-360-plus .amount-big {
      color: #7c2d12;
    }

    .age-summary-card.days-360-plus .percentage {
      color: #7c2d12;
    }

    .age-table {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    .age-table table {
      min-width: 900px;
      border-radius: 0;
      font-size: 12px;
    }

    .age-table th, .age-table td {
      padding: 8px 10px;
    }

    .age-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .sort-container {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .sort-label {
      font-weight: 600;
      color: #4a5568;
      font-size: 16px;
    }

    .sort-button {
      padding: 10px 20px;
      font-size: 14px;
      background: white;
      color: #4a5568;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .sort-button:hover {
      border-color: #667eea;
      color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.2);
    }

    .sort-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
    }

    .customer-selector {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .customer-selector label {
      font-weight: 600;
      color: #4a5568;
      font-size: 16px;
    }

    .customer-selector select {
      padding: 12px 20px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      outline: none;
      background: white;
      min-width: 300px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .customer-selector select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .statement-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      background: linear-gradient(135deg, #f6f9fc 0%, #e9ecef 100%);
      border-radius: 15px;
      border: 1px solid #e2e8f0;
    }

    .statement-header h2 {
      color: #4a5568;
      margin: 0;
      font-size: 24px;
    }

    .statement-header .statement-date {
      color: #718096;
      font-size: 16px;
      margin-top: 10px;
    }

    .customer-info {
      background: #f8fafc;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      border-left: 5px solid #667eea;
      border: 1px solid #e2e8f0;
    }

    .customer-info h3 {
      margin: 0 0 15px 0;
      color: #4a5568;
      font-size: 20px;
    }

    .customer-info p {
      margin: 8px 0;
      color: #718096;
      font-size: 16px;
    }

    .statement-table {
      margin-bottom: 30px;
    }

    .statement-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }

    .statement-table tr:nth-child(even) {
      background-color: #f8fafc;
    }

    .statement-total {
      background: #e6f2ff !important;
      font-weight: 700;
      font-size: 18px;
    }

    .statement-footer {
      margin-top: 40px;
      padding: 25px;
      background: #f0f8ff;
      border-radius: 15px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .statement-footer p {
      margin: 8px 0;
      color: #718096;
    }

    .statement-footer .note {
      font-style: italic;
      color: #a0aec0;
      margin-top: 15px;
    }

    .go-back-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 25px;
      background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(108,117,125,0.3);
      margin-top: 20px;
    }

    .go-back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(108,117,125,0.4);
    }

    .age-filter-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      display: none;
    }

    .age-filter-container.show {
      display: grid;
    }

    .age-filter-box {
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .age-filter-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.15);
    }

    .age-filter-box h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .age-filter-box button {
      width: 100%;
      padding: 12px 20px;
      font-size: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .age-filter-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(102,126,234,0.4);
    }

    .age-filter-box.days-0-30 {
      border-top: 4px solid #38a169;
    }

    .age-filter-box.days-0-30 h3 {
      color: #38a169;
    }

    .age-filter-box.days-31-60 {
      border-top: 4px solid #d69e2e;
    }

    .age-filter-box.days-31-60 h3 {
      color: #d69e2e;
    }

    .age-filter-box.days-61-90 {
      border-top: 4px solid #dd6b20;
    }

    .age-filter-box.days-61-90 h3 {
      color: #dd6b20;
    }

    .age-filter-box.days-91-180 {
      border-top: 4px solid #e53e3e;
    }

    .age-filter-box.days-91-180 h3 {
      color: #e53e3e;
    }

    .age-filter-box.days-181-360 {
      border-top: 4px solid #9f1239;
    }

    .age-filter-box.days-181-360 h3 {
      color: #9f1239;
    }

    .age-filter-box.days-360-plus {
      border-top: 4px solid #7c2d12;
    }

    .age-filter-box.days-360-plus h3 {
      color: #7c2d12;
    }

    .alert-box {
      background: #fff5f5;
      border-left: 4px solid #e53e3e;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .alert-box h3 {
      color: #e53e3e;
      margin: 0 0 10px 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-box p {
      color: #742a2a;
      margin: 0;
    }

    /* New styles for separating invoices and excess payments */
    .payment-separator {
      border-top: 2px dashed #e2e8f0;
      margin: 15px 0;
    }

    .payment-header {
      background-color: #f0f8ff;
      font-weight: 700;
      color: #38a169;
      text-align: center;
    }

    /* New styles for total row positioning */
    .total-row {
      background-color: #e6f2ff;
      font-weight: 700;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      h1 {
        font-size: 24px;
      }

      .search-container {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .search-box {
        padding: 20px;
      }

      .summary-totals {
        grid-template-columns: 1fr;
      }

      .download-container {
        flex-direction: column;
        align-items: center;
      }

      .download-button {
        width: 100%;
        max-width: 300px;
      }

      .age-table {
        font-size: 10px;
      }

      .age-table table {
        min-width: 700px;
      }

      .age-table th, .age-table td {
        padding: 6px 8px;
      }

      .age-filter-container {
        grid-template-columns: 1fr;
      }

      .modal-content {
        width: 95%;
        margin: 10% auto;
      }

      .invoice-details {
        grid-template-columns: 1fr;
      }

      .login-card {
        margin: 20px;
        padding: 30px;
      }
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1><i class="fas fa-building"></i> Outstanding Invoice Management System</h1>
        <p>Please login to access the system</p>
      </div>
      
      <div id="errorMessage" class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        Invalid username or password. Please try again.
      </div>
      
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" placeholder="Enter your username" required autocomplete="username">
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter your password" required autocomplete="current-password">
        </div>
        
        <button type="submit" id="loginButton" class="login-button">
          <i class="fas fa-sign-in-alt"></i> Login
        </button>
      </form>
      
      <div id="loadingIndicator" class="loading-indicator">
        <i class="fas fa-spinner fa-spin"></i> Authenticating...
      </div>
    </div>
  </div>

  <!-- Main Application (hidden until login) -->
  <div id="mainApp" class="main-app">
    <div class="logout-container">
      <button class="logout-button" onclick="handleLogout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>

    <div class="container">
      <h1><i class="fas fa-building"></i> ABS Outstanding Invoice Management System</h1>
      <h2>Outstanding Invoice Analysis</h2>
      <div id="asOfDate" class="as-of-date"></div>

      <div class="search-container">
        <div class="search-box">
          <h3><i class="fas fa-search"></i> Search by Site No</h3>
          <input type="text" id="siteNoInput" placeholder="Enter Site No" onkeypress="handleKeyPress(event, 'site')" />
          <button onclick="searchBySiteNo()"><i class="fas fa-search"></i> Search Site No</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-file-invoice"></i> Search by Invoice Number</h3>
          <input type="text" id="invoiceNoInput" placeholder="Enter Invoice Number" onkeypress="handleKeyPress(event, 'invoice')" />
          <button onclick="searchByInvoiceNo()"><i class="fas fa-search"></i> Search Invoice No</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-users"></i> Find Site by Customer Name</h3>
          <input type="text" id="customerNameInput" placeholder="Enter part of Customer Name" onkeypress="handleKeyPress(event, 'customer')" />
          <button onclick="searchByCustomerName()"><i class="fas fa-search"></i> Find Site</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-chart-bar"></i> Total Customer Outstanding Summary</h3>
          <button onclick="showCustomerSummary()"><i class="fas fa-chart-bar"></i> Show All Customer Outstandings</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-user-tie"></i> Outstanding New VO Wise</h3>
          <button onclick="showNewVOSummary()"><i class="fas fa-user-tie"></i> Show New VO Outstandings</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-user-check"></i> Outstanding SM Wise</h3>
          <button onclick="showSMSummary()"><i class="fas fa-user-check"></i> Show SM Outstandings</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-user-shield"></i> Outstanding OM Wise</h3>
          <button onclick="showOMSummary()"><i class="fas fa-user-shield"></i> Show OM Outstandings</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-user-cog"></i> Outstanding Collector Wise</h3>
          <button onclick="showCollectorSummary()"><i class="fas fa-user-cog"></i> Show Collector Outstandings</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-clock"></i> Age Analysis</h3>
          <button onclick="showAgeAnalysis()"><i class="fas fa-hourglass-half"></i> Show Age Analysis</button>
        </div>

        <div class="search-box">
          <h3><i class="fas fa-filter"></i> Filter Invoices by Age</h3>
          <button onclick="toggleAgeFilterContainer()"><i class="fas fa-filter"></i> Show Age Filter Options</button>
        </div>
      </div>

      <div id="ageFilterContainer" class="age-filter-container">
        <div class="age-filter-box days-0-30">
          <h3><i class="fas fa-hourglass-start"></i> 0-30 Days</h3>
          <button onclick="showInvoicesByAge('0-30')"><i class="fas fa-filter"></i> Show Invoices</button>
        </div>

        <div class="age-filter-box days-31-60">
          <h3><i class="fas fa-hourglass-half"></i> 31-60 Days</h3>
          <button onclick="showInvoicesByAge('31-60')"><i class="fas fa-filter"></i> Show Invoices</button>
        </div>

        <div class="age-filter-box days-61-90">
          <h3><i class="fas fa-hourglass-end"></i> 61-90 Days</h3>
          <button onclick="showInvoicesByAge('61-90')"><i class="fas fa-filter"></i> Show Invoices</button>
        </div>

        <div class="age-filter-box days-91-180">
          <h3><i class="fas fa-calendar-week"></i> 91-180 Days</h3>
          <button onclick="showInvoicesByAge('91-180')"><i class="fas fa-filter"></i> Show Invoices</button>
        </div>

        <div class="age-filter-box days-181-360">
          <h3><i class="fas fa-calendar-alt"></i> 181-360 Days</h3>
          <button onclick="showInvoicesByAge('181-360')"><i class="fas fa-filter"></i> Show Invoices</button>
        </div>

        <div class="age-filter-box days-360-plus">
          <h3><i class="fas fa-calendar-times"></i> More than 360 Days</h3>
          <button onclick="showInvoicesByAge('360-plus')"><i class="fas fa-filter"></i> Show Invoices</button>
        </div>
      </div>

      <div id="results"></div>
    </div>
  </div>

  <!-- Invoice Breakdown Modal -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-file-invoice-dollar"></i> Invoice Details</h2>
        <button class="close" onclick="closeInvoiceModal()">&times;</button>
      </div>
      <div class="modal-body" id="invoiceModalBody">
        <!-- Invoice details will be populated here -->
      </div>
    </div>
  </div>

  <script>
    // Google Sheet URL
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1nLIYmZmxgmq2pZkGM0xUSu3ONMg_7hnxE4WPkLf0UQY/gviz/tq?tqx=out:json';
    let currentSiteNo = '';
    let rawSummaryData = null;
    let rawNewVOData = null;
    let rawSMData = null;
    let rawOMData = null;
    let rawCollectorData = null;
    let rawAgeAnalysisData = null;
    let currentSortType = 'alphabetical';
    let currentView = null;
    let allCustomers = [];
    let isWithoutExcessView = false;
    let previousView = null;
    let navigationHistory = [];
    let currentAgeFilter = null;
    let rawAgeFilterData = {};
    let currentUser = null;
    let users = []; // Will store user credentials from Google Sheet

    // Login functionality
    async function fetchUsers() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        
        if (!json.table || !json.table.rows) return [];
        
        users = [];
        json.table.rows.forEach(row => {
          // Column O is index 14 (0-based)
          // Column P is index 15 (0-based)
          const username = row.c[14]?.v?.toString() || '';
          const password = row.c[15]?.v?.toString() || '';
          
          if (username && password) {
            users.push({ username, password });
          }
        });
        
        return users;
      } catch (error) {
        console.error('Error fetching user data:', error);
        return [];
      }
    }

    function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const loginButton = document.getElementById('loginButton');
      const errorMessage = document.getElementById('errorMessage');
      const loadingIndicator = document.getElementById('loadingIndicator');
      
      // Show loading state
      loginButton.disabled = true;
      loadingIndicator.style.display = 'block';
      errorMessage.style.display = 'none';
      
      // Check credentials
      const userFound = users.find(user => 
        user.username.toLowerCase() === username.toLowerCase() && 
        user.password === password
      );
      
      // Simulate network delay for better UX
      setTimeout(() => {
        if (userFound) {
          // Store user session
          currentUser = userFound.username;
          sessionStorage.setItem('currentUser', currentUser);
          
          // Hide login screen and show main app
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainApp').classList.add('logged-in');
          
          // Initialize the main application
          initializeApp();
        } else {
          // Show error message
          errorMessage.style.display = 'block';
        }
        
        // Reset loading state
        loginButton.disabled = false;
        loadingIndicator.style.display = 'none';
      }, 1000);
    }

    function handleLogout() {
      // Clear user session
      currentUser = null;
      sessionStorage.removeItem('currentUser');
      
      // Show login screen and hide main app
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').classList.remove('logged-in');
      
      // Clear login form
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function checkLoginStatus() {
      // Check if user is already logged in
      const savedUser = sessionStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = savedUser;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').classList.add('logged-in');
        initializeApp();
      }
    }

    async function initializeApp() {
      await fetchAsOfDate();
      await loadAllCustomers();
    }

    // Function to toggle the age filter container visibility
    function toggleAgeFilterContainer() {
      const container = document.getElementById('ageFilterContainer');
      container.classList.toggle('show');
      
      // Change button text based on visibility
      const button = document.querySelector('.search-box:nth-child(9) button');
      if (container.classList.contains('show')) {
        button.innerHTML = '<i class="fas fa-times"></i> Hide Age Filter Options';
      } else {
        button.innerHTML = '<i class="fas fa-filter"></i> Show Age Filter Options';
      }
    }

    async function fetchSheetData() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        if (!json.table || !json.table.rows) return [];
        return json.table.rows;
      } catch (error) {
        console.error('Error fetching sheet data:', error);
        return [];
      }
    }

    function handleKeyPress(event, type) {
      if (event.key === 'Enter') {
        if (type === 'site') searchBySiteNo();
        else if (type === 'invoice') searchByInvoiceNo();
        else if (type === 'customer') searchByCustomerName();
      }
    }

    function formatAmount(num) {
      return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function parseDate(dateString) {
      if (!dateString) return null;
      
      const parsed = Date.parse(dateString);
      if (!isNaN(parsed)) return new Date(parsed);
      
      const ddmmyyyy = dateString.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (ddmmyyyy) {
        return new Date(parseInt(ddmmyyyy[3]), parseInt(ddmmyyyy[2]) - 1, parseInt(ddmmyyyy[1]));
      }
      
      const ddmmyyyy2 = dateString.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
      if (ddmmyyyy2) {
        return new Date(parseInt(ddmmyyyy2[3]), parseInt(ddmmyyyy2[2]) - 1, parseInt(ddmmyyyy2[1]));
      }
      
      const mmddyyyy = dateString.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (mmddyyyy) {
        return new Date(parseInt(mmddyyyy[3]), parseInt(mmddyyyy[1]) - 1, parseInt(mmddyyyy[2]));
      }
      
      const yyyymmdd = dateString.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (yyyymmdd) {
        return new Date(parseInt(yyyymmdd[1]), parseInt(yyyymmdd[2]) - 1, parseInt(yyyymmdd[3]));
      }
      
      return null;
    }

    function calculateDueDays(invoiceDate) {
      const invDate = parseDate(invoiceDate);
      if (!invDate) return 0;
      
      const today = new Date();
      const diffTime = today - invDate;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return Math.max(0, diffDays);
    }

    function getDueClass(days) {
      if (days <= 30) return 'days-0-30';
      if (days <= 60) return 'days-31-60';
      if (days <= 90) return 'days-61-90';
      return 'days-91-plus';
    }

    function calculateAge(invoiceDate) {
      const invDate = parseDate(invoiceDate);
      if (!invDate) return 0;
      
      const today = new Date();
      const diffTime = Math.abs(today - invDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays;
    }

    function getAgeBracket(days) {
      if (days >= 0 && days <= 30) return '0-30';
      if (days > 30 && days <= 60) return '31-60';
      if (days > 60 && days <= 90) return '61-90';
      if (days > 90 && days <= 180) return '91-180';
      if (days > 180 && days <= 360) return '181-360';
      if (days > 360) return '>360';
      return '0-30';
    }

    function getAgeClass(bracket) {
      if (bracket === '0-30') return 'days-0-30';
      if (bracket === '31-60') return 'days-31-60';
      if (bracket === '61-90') return 'days-61-90';
      if (bracket === '91-180') return 'days-91-180';
      if (bracket === '181-360') return 'days-181-360';
      if (bracket === '>360') return 'days-360-plus';
      return '';
    }

    // Function to sort invoices by age (largest to smallest) for outstanding invoices
    function sortInvoicesByAge(invoices) {
      // Separate outstanding invoices and excess payments
      const outstandingInvoices = invoices.filter(inv => !inv.invoiceType.toLowerCase().includes('payment'));
      const excessPayments = invoices.filter(inv => inv.invoiceType.toLowerCase().includes('payment'));
      
      // Sort outstanding invoices by age (largest to smallest)
      outstandingInvoices.sort((a, b) => {
        const ageA = calculateAge(a.date);
        const ageB = calculateAge(b.date);
        return ageB - ageA; // Sort by age descending
      });
      
      // Sort excess payments by date (newest to oldest)
      excessPayments.sort((a, b) => {
        const dateA = parseDate(a.date);
        const dateB = parseDate(b.date);
        return dateB - dateA; // Sort by date descending
      });
      
      // Return combined array with outstanding invoices first, then excess payments
      return [...outstandingInvoices, ...excessPayments];
    }

    function sortData(data, sortType) {
      if (sortType === 'alphabetical') {
        return data.sort((a, b) => {
          const nameA = a.customerName || a.name || a.newVO || a.sm || a.om || a.collector || '';
          const nameB = b.customerName || b.name || b.newVO || b.sm || b.om || b.collector || '';
          return nameA.localeCompare(nameB);
        });
      } else if (sortType === 'amount') {
        return data.sort((a, b) => {
          const totalA = a.amountRaw !== undefined ? a.amountRaw : 
                        (a.total !== undefined ? a.total : 0);
          const totalB = b.amountRaw !== undefined ? b.amountRaw : 
                        (b.total !== undefined ? b.total : 0);
          return totalB - totalA;
        });
      }
      return data;
    }

    function renderSortButtons(viewType) {
      return `
        <div class="sort-container">
          <span class="sort-label"><i class="fas fa-sort"></i> Sort by:</span>
          <button class="sort-button ${currentSortType === 'alphabetical' ? 'active' : ''}" 
                  onclick="changeSortType('alphabetical', '${viewType}')">
            <i class="fas fa-sort-alpha-down"></i> Name (A-Z)
          </button>
          <button class="sort-button ${currentSortType === 'amount' ? 'active' : ''}" 
                  onclick="changeSortType('amount', '${viewType}')">
            <i class="fas fa-sort-amount-down"></i> Amount (High to Low)
          </button>
        </div>
      `;
    }

    function changeSortType(sortType, viewType) {
      currentSortType = sortType;
      
      if (viewType === 'summary' && rawSummaryData) {
        const sortedData = sortData([...rawSummaryData], sortType);
        renderCustomerSummary(sortedData);
      } else if (viewType === 'newVO' && rawNewVOData) {
        const sortedData = sortData([...rawNewVOData], sortType);
        renderNewVOSummary(sortedData);
      } else if (viewType === 'sm' && rawSMData) {
        const sortedData = sortData([...rawSMData], sortType);
        renderSMSummary(sortedData);
      } else if (viewType === 'om' && rawOMData) {
        const sortedData = sortData([...rawOMData], sortType);
        renderOMSummary(sortedData);
      } else if (viewType === 'collector' && rawCollectorData) {
        const sortedData = sortData([...rawCollectorData], sortType);
        renderCollectorSummary(sortedData);
      } else if (viewType === 'ageAnalysis' && rawAgeAnalysisData) {
        const sortedData = sortData([...rawAgeAnalysisData], sortType);
        renderAgeAnalysis(sortedData);
      } else if (viewType === 'ageFilter' && currentAgeFilter && rawAgeFilterData[currentAgeFilter]) {
        const sortedData = sortData([...rawAgeFilterData[currentAgeFilter]], sortType);
        renderInvoicesByAge(sortedData, currentAgeFilter);
      }
    }

    async function fetchAsOfDate() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        
        if (json.table && json.table.cols && json.table.cols.length > 0) {
          const firstColLabel = json.table.cols[0].label || '';
          
          if (firstColLabel) {
            document.getElementById('asOfDate').innerHTML = `<i class="fas fa-calendar-alt"></i> ${firstColLabel.toString()}`;
          } else {
            document.getElementById('asOfDate').innerHTML = '<i class="fas fa-calendar-alt"></i> As of Date not found';
          }
        }
      } catch (error) {
        console.error('Error fetching As of Date:', error);
        document.getElementById('asOfDate').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error loading date';
      }
    }

    async function loadAllCustomers() {
      const rows = await fetchSheetData();
      const customerMap = new Map();

      rows.forEach(row => {
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const customerName = row.c[0]?.v?.toString() || '';
        
        if (siteNo && customerName && !customerMap.has(siteNo)) {
          customerMap.set(siteNo, customerName);
        }
      });

      allCustomers = Array.from(customerMap.entries()).map(([siteNo, customerName]) => ({
        siteNo,
        customerName,
        displayName: `${customerName} (${siteNo})`
      })).sort((a, b) => a.customerName.localeCompare(b.customerName));
    }

    async function showCustomerSummary() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading customer summary data...</div>`;

      const rows = await fetchSheetData();
      const customerData = {};

      rows.forEach(row => {
        const customerName = row.c[0]?.v?.toString() || '';
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const siteName = row.c[2]?.v?.toString() || '';
        const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
        const invoiceBalance = row.c[11]?.v || 0;

        if (!customerName || !siteNo) return;

        if (!customerData[customerName]) {
          customerData[customerName] = {
            customerName,
            sites: new Map(),
            totalOutstanding: 0,
            excessPayment: 0
          };
        }

        const customer = customerData[customerName];
        
        if (!customer.sites.has(siteNo)) {
          customer.sites.set(siteNo, {
            siteNo,
            siteName,
            outstanding: 0,
            excessPayment: 0
          });
        }

        const site = customer.sites.get(siteNo);
        
        if (invoiceType === 'payment') {
          site.excessPayment += invoiceBalance;
          customer.excessPayment += invoiceBalance;
        } else {
          site.outstanding += invoiceBalance;
          customer.totalOutstanding += invoiceBalance;
        }
      });

      const summaryArray = Object.entries(customerData).map(([customerName, data]) => ({
        customerName,
        sites: Array.from(data.sites.values()),
        totalOutstanding: data.totalOutstanding,
        excessPayment: data.excessPayment,
        netOutstanding: data.totalOutstanding + data.excessPayment
      })).filter(item => item.totalOutstanding !== 0 || item.excessPayment !== 0);

      rawSummaryData = summaryArray;
      const sortedData = sortData([...summaryArray], currentSortType);
      
      // Save current state to navigation history
      navigationHistory.push({
        view: 'summary',
        sortType: currentSortType,
        data: sortedData
      });
      
      previousView = currentView;
      currentView = 'summary';
      isWithoutExcessView = false;

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No outstanding invoices found.</div>`;
        return;
      }

      renderCustomerSummary(sortedData);
    }

    function renderCustomerSummary(data) {
      const resultsDiv = document.getElementById('results');
      const summaryArray = data;

      let totalOutstanding = 0;
      let totalExcess = 0;
      let totalNet = 0;

      let html = renderSortButtons('summary');
      html += `<div class="section-title"><i class="fas fa-chart-bar"></i> Total Customer Outstanding Summary</div>
               <table>
                 <thead>
                   <tr>
                     <th>Customer Name</th>
                     <th>Site Count</th>
                     <th>Total Outstanding (Rs.)</th>
                     <th>Excess Payment (Rs.)</th>
                     <th>Net Outstanding (Rs.)</th>
                   </tr>
                 </thead>
                 <tbody>`;

      summaryArray.forEach(item => {
        totalOutstanding += item.totalOutstanding;
        totalExcess += item.excessPayment;
        totalNet += item.netOutstanding;

        const excessDisplay = item.excessPayment < 0 
          ? `(${formatAmount(Math.abs(item.excessPayment))})` 
          : formatAmount(item.excessPayment);
        const excessClass = item.excessPayment < 0 ? 'amount payment' : 'amount';

        html += `<tr>
          <td><a class="site-link" onclick="showCustomerSites('${item.customerName}')">${item.customerName}</a></td>
          <td class="amount">${item.sites.length}</td>
          <td class="amount">${formatAmount(item.totalOutstanding)}</td>
          <td class="${excessClass}">${excessDisplay}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.netOutstanding)}</td>
        </tr>`;
      });

      const totalExcessDisplay = totalExcess < 0 
        ? `(${formatAmount(Math.abs(totalExcess))})` 
        : formatAmount(totalExcess);

      html += `<tr class="total-row">
        <td style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${summaryArray.reduce((sum, item) => sum + item.sites.length, 0)}</td>
        <td class="amount">${formatAmount(totalOutstanding)}</td>
        <td class="amount payment">${totalExcessDisplay}</td>
        <td class="amount">${formatAmount(totalNet)}</td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
          <div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-users"></i> Total Customers</h3>
          <div class="amount-big">${summaryArray.length}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadCustomerSummaryPDF()"><i class="fas fa-file-pdf"></i> Download asPDF</button>
        <button class="download-button excel" onclick="downloadCustomerSummaryExcel()"><i class="fas fa-file-excel"></i> Download as Excel</button>
      </div>`;

      html += `<div style="text-align: center;">
        <button class="go-back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Go Back</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadCustomerSummaryPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('Invoice Management System', 40, 40);
      doc.setFontSize(12);
      doc.text('Total Customer Outstanding Summary', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('Customer Outstanding Summary.pdf');
    }

    function downloadCustomerSummaryExcel() {
      const wb = XLSX.utils.book_new();
      
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const wsData = [];
      
      wsData.push(['Invoice Management System']);
      wsData.push(['Total Customer Outstanding Summary']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      wsData.push([
        'Customer Name', 
        'Site Count', 
        'Total Outstanding (Rs.)', 
        'Excess Payment (Rs.)', 
        'Net Outstanding (Rs.)'
      ]);
      
      const summaryTable = document.querySelector('#results table tbody');
      if (summaryTable) {
        const rows = Array.from(summaryTable.rows).slice(0, -1);
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        const totalsRow = summaryTable.rows[summaryTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [
        { wch: 35 }, 
        { wch: 15 }, 
        { wch: 22 }, 
        { wch: 22 }, 
        { wch: 25 }
      ];
      ws['!cols'] = colWidths;
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            }
          }
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } });
            }
          }
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      XLSX.utils.book_append_sheet(wb, ws, "Customer Summary");
      
      const fileName = `Customer Outstanding Summary_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function showNewVOSummary() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading New VO summary data...</div>`;

      const rows = await fetchSheetData();
      const voData = {};

      rows.forEach(row => {
        const newVO = row.c[4]?.v?.toString() || '';
        const customerName = row.c[0]?.v?.toString() || '';
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const siteName = row.c[2]?.v?.toString() || '';
        const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
        const invoiceBalance = row.c[11]?.v || 0;

        if (!newVO) return;

        if (!voData[newVO]) {
          voData[newVO] = {
            newVO,
            sites: new Map(),
            totalOutstanding: 0,
            excessPayment: 0
          };
        }

        const vo = voData[newVO];
        
        if (!vo.sites.has(siteNo)) {
          vo.sites.set(siteNo, {
            siteNo,
            siteName,
            customerName,
            outstanding: 0,
            excessPayment: 0
          });
        }

        const site = vo.sites.get(siteNo);
        
        if (invoiceType === 'payment') {
          site.excessPayment += invoiceBalance;
          vo.excessPayment += invoiceBalance;
        } else {
          site.outstanding += invoiceBalance;
          vo.totalOutstanding += invoiceBalance;
        }
      });

      const summaryArray = Object.entries(voData).map(([newVO, data]) => ({
        newVO,
        sites: Array.from(data.sites.values()),
        totalOutstanding: data.totalOutstanding,
        excessPayment: data.excessPayment,
        netOutstanding: data.totalOutstanding + data.excessPayment
      })).filter(item => item.totalOutstanding !== 0 || item.excessPayment !== 0);

      rawNewVOData = summaryArray;
      const sortedData = sortData([...summaryArray], currentSortType);
      
      // Save current state to navigation history
      navigationHistory.push({
        view: 'newVO',
        sortType: currentSortType,
        data: sortedData
      });
      
      previousView = currentView;
      currentView = 'newVO';

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No outstanding invoices found for New VO.</div>`;
        return;
      }

      renderNewVOSummary(sortedData);
    }

    function renderNewVOSummary(data) {
      const resultsDiv = document.getElementById('results');
      const summaryArray = data;

      let totalOutstanding = 0;
      let totalExcess = 0;
      let totalNet = 0;

      let html = renderSortButtons('newVO');
      html += `<div class="section-title"><i class="fas fa-user-tie"></i> Outstanding New VO Wise</div>
               <table>
                 <thead>
                   <tr>
                     <th>New VO</th>
                     <th>Site Count</th>
                     <th>Total Outstanding (Rs.)</th>
                     <th>Excess Payment (Rs.)</th>
                     <th>Net Outstanding (Rs.)</th>
                   </tr>
                 </thead>
                 <tbody>`;

      summaryArray.forEach(item => {
        totalOutstanding += item.totalOutstanding;
        totalExcess += item.excessPayment;
        totalNet += item.netOutstanding;

        const excessDisplay = item.excessPayment < 0 
          ? `(${formatAmount(Math.abs(item.excessPayment))})` 
          : formatAmount(item.excessPayment);
        const excessClass = item.excessPayment < 0 ? 'amount payment' : 'amount';

        html += `<tr>
          <td><a class="site-link" onclick="showNewVOSites('${item.newVO}')">${item.newVO}</a></td>
          <td class="amount">${item.sites.length}</td>
          <td class="amount">${formatAmount(item.totalOutstanding)}</td>
          <td class="${excessClass}">${excessDisplay}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.netOutstanding)}</td>
        </tr>`;
      });

      const totalExcessDisplay = totalExcess < 0 
        ? `(${formatAmount(Math.abs(totalExcess))})` 
        : formatAmount(totalExcess);

      html += `<tr class="total-row">
        <td style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${summaryArray.reduce((sum, item) => sum + item.sites.length, 0)}</td>
        <td class="amount">${formatAmount(totalOutstanding)}</td>
        <td class="amount payment">${totalExcessDisplay}</td>
        <td class="amount">${formatAmount(totalNet)}</td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
          <div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-user-tie"></i> Total New VOs</h3>
          <div class="amount-big">${summaryArray.length}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadNewVOSummaryPDF()"><i class="fas fa-file-pdf"></i> Download as PDF</button>
        <button class="download-button excel" onclick="downloadNewVOSummaryExcel()"><i class="fas fa-file-excel"></i> Download as Excel</button>
      </div>`;

      html += `<div style="text-align: center;">
        <button class="go-back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Go Back</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadNewVOSummaryPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('Invoice Management System', 40, 40);
      doc.setFontSize(12);
      doc.text('Outstanding New VO Wise', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('New VO Outstanding Summary.pdf');
    }

    function downloadNewVOSummaryExcel() {
      const wb = XLSX.utils.book_new();
      
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const wsData = [];
      
      wsData.push(['Invoice Management System']);
      wsData.push(['Outstanding New VO Wise']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      wsData.push([
        'New VO', 
        'Site Count', 
        'Total Outstanding (Rs.)', 
        'Excess Payment (Rs.)', 
        'Net Outstanding (Rs.)'
      ]);
      
      const summaryTable = document.querySelector('#results table tbody');
      if (summaryTable) {
        const rows = Array.from(summaryTable.rows).slice(0, -1);
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        const totalsRow = summaryTable.rows[summaryTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [
        { wch: 35 }, 
        { wch: 15 }, 
        { wch: 22 }, 
        { wch: 22 }, 
        { wch: 25 }
      ];
      ws['!cols'] = colWidths;
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            }
          }
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } });
            }
          }
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      XLSX.utils.book_append_sheet(wb, ws, "New VO Summary");
      
      const fileName = `New VO Outstanding Summary_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function showSMSummary() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading SM summary data...</div>`;

      const rows = await fetchSheetData();
      const smData = {};

      rows.forEach(row => {
        const sm = row.c[5]?.v?.toString() || '';
        const customerName = row.c[0]?.v?.toString() || '';
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const siteName = row.c[2]?.v?.toString() || '';
        const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
        const invoiceBalance = row.c[11]?.v || 0;

        if (!sm) return;

        if (!smData[sm]) {
          smData[sm] = {
            sm,
            sites: new Map(),
            totalOutstanding: 0,
            excessPayment: 0
          };
        }

        const smRecord = smData[sm];
        
        if (!smRecord.sites.has(siteNo)) {
          smRecord.sites.set(siteNo, {
            siteNo,
            siteName,
            customerName,
            outstanding: 0,
            excessPayment: 0
          });
        }

        const site = smRecord.sites.get(siteNo);
        
        if (invoiceType === 'payment') {
          site.excessPayment += invoiceBalance;
          smRecord.excessPayment += invoiceBalance;
        } else {
          site.outstanding += invoiceBalance;
          smRecord.totalOutstanding += invoiceBalance;
        }
      });

      const summaryArray = Object.entries(smData).map(([sm, data]) => ({
        sm,
        sites: Array.from(data.sites.values()),
        totalOutstanding: data.totalOutstanding,
        excessPayment: data.excessPayment,
        netOutstanding: data.totalOutstanding + data.excessPayment
      })).filter(item => item.totalOutstanding !== 0 || item.excessPayment !== 0);

      rawSMData = summaryArray;
      const sortedData = sortData([...summaryArray], currentSortType);
      
      // Save current state to navigation history
      navigationHistory.push({
        view: 'sm',
        sortType: currentSortType,
        data: sortedData
      });
      
      previousView = currentView;
      currentView = 'sm';

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No outstanding invoices found for SM.</div>`;
        return;
      }

      renderSMSummary(sortedData);
    }

    function renderSMSummary(data) {
      const resultsDiv = document.getElementById('results');
      const summaryArray = data;

      let totalOutstanding = 0;
      let totalExcess = 0;
      let totalNet = 0;

      let html = renderSortButtons('sm');
      html += `<div class="section-title"><i class="fas fa-user-check"></i> Outstanding SM Wise</div>
               <table>
                 <thead>
                   <tr>
                     <th>SM</th>
                     <th>Site Count</th>
                     <th>Total Outstanding (Rs.)</th>
                     <th>Excess Payment (Rs.)</th>
                     <th>Net Outstanding (Rs.)</th>
                   </tr>
                 </thead>
                 <tbody>`;

      summaryArray.forEach(item => {
        totalOutstanding += item.totalOutstanding;
        totalExcess += item.excessPayment;
        totalNet += item.netOutstanding;

        const excessDisplay = item.excessPayment < 0 
          ? `(${formatAmount(Math.abs(item.excessPayment))})` 
          : formatAmount(item.excessPayment);
        const excessClass = item.excessPayment < 0 ? 'amount payment' : 'amount';

        html += `<tr>
          <td><a class="site-link" onclick="showSMSites('${item.sm}')">${item.sm}</a></td>
          <td class="amount">${item.sites.length}</td>
          <td class="amount">${formatAmount(item.totalOutstanding)}</td>
          <td class="${excessClass}">${excessDisplay}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.netOutstanding)}</td>
        </tr>`;
      });

      const totalExcessDisplay = totalExcess < 0 
        ? `(${formatAmount(Math.abs(totalExcess))})` 
        : formatAmount(totalExcess);

      html += `<tr class="total-row">
        <td style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${summaryArray.reduce((sum, item) => sum + item.sites.length, 0)}</td>
        <td class="amount">${formatAmount(totalOutstanding)}</td>
        <td class="amount payment">${totalExcessDisplay}</td>
        <td class="amount">${formatAmount(totalNet)}</td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
          <div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-user-check"></i> Total SMs</h3>
          <div class="amount-big">${summaryArray.length}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadSMSummaryPDF()"><i class="fas fa-file-pdf"></i> Download as PDF</button>
        <button class="download-button excel" onclick="downloadSMSummaryExcel()"><i class="fas fa-file-excel"></i> Download as Excel</button>
      </div>`;

      html += `<div style="text-align: center;">
        <button class="go-back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Go Back</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadSMSummaryPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('Invoice Management System', 40, 40);
      doc.setFontSize(12);
      doc.text('Outstanding SM Wise', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('SM Outstanding Summary.pdf');
    }

    function downloadSMSummaryExcel() {
      const wb = XLSX.utils.book_new();
      
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const wsData = [];
      
      wsData.push(['Invoice Management System']);
      wsData.push(['Outstanding SM Wise']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      wsData.push([
        'SM', 
        'Site Count', 
        'Total Outstanding (Rs.)', 
        'Excess Payment (Rs.)', 
        'Net Outstanding (Rs.)'
      ]);
      
      const summaryTable = document.querySelector('#results table tbody');
      if (summaryTable) {
        const rows = Array.from(summaryTable.rows).slice(0, -1);
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        const totalsRow = summaryTable.rows[summaryTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [
        { wch: 35 }, 
        { wch: 15 }, 
        { wch: 22 }, 
        { wch: 22 }, 
        { wch: 25 }
      ];
      ws['!cols'] = colWidths;
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            }
          }
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } });
            }
          }
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      XLSX.utils.book_append_sheet(wb, ws, "SM Summary");
      
      const fileName = `SM Outstanding Summary_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function showOMSummary() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading OM summary data...</div>`;

      const rows = await fetchSheetData();
      const omData = {};

      rows.forEach(row => {
        const om = row.c[6]?.v?.toString() || '';
        const customerName = row.c[0]?.v?.toString() || '';
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const siteName = row.c[2]?.v?.toString() || '';
        const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
        const invoiceBalance = row.c[11]?.v || 0;

        if (!om) return;

        if (!omData[om]) {
          omData[om] = {
            om,
            sites: new Map(),
            totalOutstanding: 0,
            excessPayment: 0
          };
        }

        const omRecord = omData[om];
        
        if (!omRecord.sites.has(siteNo)) {
          omRecord.sites.set(siteNo, {
            siteNo,
            siteName,
            customerName,
            outstanding: 0,
            excessPayment: 0
          });
        }

        const site = omRecord.sites.get(siteNo);
        
        if (invoiceType === 'payment') {
          site.excessPayment += invoiceBalance;
          omRecord.excessPayment += invoiceBalance;
        } else {
          site.outstanding += invoiceBalance;
          omRecord.totalOutstanding += invoiceBalance;
        }
      });

      const summaryArray = Object.entries(omData).map(([om, data]) => ({
        om,
        sites: Array.from(data.sites.values()),
        totalOutstanding: data.totalOutstanding,
        excessPayment: data.excessPayment,
        netOutstanding: data.totalOutstanding + data.excessPayment
      })).filter(item => item.totalOutstanding !== 0 || item.excessPayment !== 0);

      rawOMData = summaryArray;
      const sortedData = sortData([...summaryArray], currentSortType);
      
      // Save current state to navigation history
      navigationHistory.push({
        view: 'om',
        sortType: currentSortType,
        data: sortedData
      });
      
      previousView = currentView;
      currentView = 'om';

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No outstanding invoices found for OM.</div>`;
        return;
      }

      renderOMSummary(sortedData);
    }

    function renderOMSummary(data) {
      const resultsDiv = document.getElementById('results');
      const summaryArray = data;

      let totalOutstanding = 0;
      let totalExcess = 0;
      let totalNet = 0;

      let html = renderSortButtons('om');
      html += `<div class="section-title"><i class="fas fa-user-shield"></i> Outstanding OM Wise</div>
               <table>
                 <thead>
                   <tr>
                     <th>OM</th>
                     <th>Site Count</th>
                     <th>Total Outstanding (Rs.)</th>
                     <th>Excess Payment (Rs.)</th>
                     <th>Net Outstanding (Rs.)</th>
                   </tr>
                 </thead>
                 <tbody>`;

      summaryArray.forEach(item => {
        totalOutstanding += item.totalOutstanding;
        totalExcess += item.excessPayment;
        totalNet += item.netOutstanding;

        const excessDisplay = item.excessPayment < 0 
          ? `(${formatAmount(Math.abs(item.excessPayment))})` 
          : formatAmount(item.excessPayment);
        const excessClass = item.excessPayment < 0 ? 'amount payment' : 'amount';

        html += `<tr>
          <td><a class="site-link" onclick="showOMSites('${item.om}')">${item.om}</a></td>
          <td class="amount">${item.sites.length}</td>
          <td class="amount">${formatAmount(item.totalOutstanding)}</td>
          <td class="${excessClass}">${excessDisplay}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.netOutstanding)}</td>
        </tr>`;
      });

      const totalExcessDisplay = totalExcess < 0 
        ? `(${formatAmount(Math.abs(totalExcess))})` 
        : formatAmount(totalExcess);

      html += `<tr class="total-row">
        <td style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${summaryArray.reduce((sum, item) => sum + item.sites.length, 0)}</td>
        <td class="amount">${formatAmount(totalOutstanding)}</td>
        <td class="amount payment">${totalExcessDisplay}</td>
        <td class="amount">${formatAmount(totalNet)}</td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
          <div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-user-shield"></i> Total OMs</h3>
          <div class="amount-big">${summaryArray.length}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadOMSummaryPDF()"><i class="fas fa-file-pdf"></i> Download as PDF</button>
        <button class="download-button excel" onclick="downloadOMSummaryExcel()"><i class="fas fa-file-excel"></i> Download as Excel</button>
      </div>`;

      html += `<div style="text-align: center;">
        <button class="go-back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Go Back</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadOMSummaryPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('Invoice Management System', 40, 40);
      doc.setFontSize(12);
      doc.text('Outstanding OM Wise', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('OM Outstanding Summary.pdf');
    }

    function downloadOMSummaryExcel() {
      const wb = XLSX.utils.book_new();
      
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const wsData = [];
      
      wsData.push(['Invoice Management System']);
      wsData.push(['Outstanding OM Wise']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      wsData.push([
        'OM', 
        'Site Count', 
        'Total Outstanding (Rs.)', 
        'Excess Payment (Rs.)', 
        'Net Outstanding (Rs.)'
      ]);
      
      const summaryTable = document.querySelector('#results table tbody');
      if (summaryTable) {
        const rows = Array.from(summaryTable.rows).slice(0, -1);
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        const totalsRow = summaryTable.rows[summaryTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [
        { wch: 35 }, 
        { wch: 15 }, 
        { wch: 22 }, 
        { wch: 22 }, 
        { wch: 25 }
      ];
      ws['!cols'] = colWidths;
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            }
          }
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } });
            }
          }
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      XLSX.utils.book_append_sheet(wb, ws, "OM Summary");      
      const fileName = `OM Outstanding Summary_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function showCollectorSummary() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading Collector summary data...</div>`;

      const rows = await fetchSheetData();
      const collectorData = {};

      rows.forEach(row => {
        const collector = row.c[7]?.v?.toString() || '';
        const customerName = row.c[0]?.v?.toString() || '';
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const siteName = row.c[2]?.v?.toString() || '';
        const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
        const invoiceBalance = row.c[11]?.v || 0;

        if (!collector) return;

        if (!collectorData[collector]) {
          collectorData[collector] = {
            collector,
            sites: new Map(),
            totalOutstanding: 0,
            excessPayment: 0
          };
        }

        const collectorRecord = collectorData[collector];
        
        if (!collectorRecord.sites.has(siteNo)) {
          collectorRecord.sites.set(siteNo, {
            siteNo,
            siteName,
            customerName,
            outstanding: 0,
            excessPayment: 0
          });
        }

        const site = collectorRecord.sites.get(siteNo);
        
        if (invoiceType === 'payment') {
          site.excessPayment += invoiceBalance;
          collectorRecord.excessPayment += invoiceBalance;
        } else {
          site.outstanding += invoiceBalance;
          collectorRecord.totalOutstanding += invoiceBalance;
        }
      });

      const summaryArray = Object.entries(collectorData).map(([collector, data]) => ({
        collector,
        sites: Array.from(data.sites.values()),
        totalOutstanding: data.totalOutstanding,
        excessPayment: data.excessPayment,
        netOutstanding: data.totalOutstanding + data.excessPayment
      })).filter(item => item.totalOutstanding !== 0 || item.excessPayment !== 0);

      rawCollectorData = summaryArray;
      const sortedData = sortData([...summaryArray], currentSortType);
      
      // Save current state to navigation history
      navigationHistory.push({
        view: 'collector',
        sortType: currentSortType,
        data: sortedData
      });
      
      previousView = currentView;
      currentView = 'collector';

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No outstanding invoices found for Collector.</div>`;
        return;
      }

      renderCollectorSummary(sortedData);
    }

    function renderCollectorSummary(data) {
      const resultsDiv = document.getElementById('results');
      const summaryArray = data;

      let totalOutstanding = 0;
      let totalExcess = 0;
      let totalNet = 0;

      let html = renderSortButtons('collector');
      html += `<div class="section-title"><i class="fas fa-user-cog"></i> Outstanding Collector Wise</div>
               <table>
                 <thead>
                   <tr>
                     <th>Collector</th>
                     <th>Site Count</th>
                     <th>Total Outstanding (Rs.)</th>
                     <th>Excess Payment (Rs.)</th>
                     <th>Net Outstanding (Rs.)</th>
                   </tr>
                 </thead>
                 <tbody>`;

      summaryArray.forEach(item => {
        totalOutstanding += item.totalOutstanding;
        totalExcess += item.excessPayment;
        totalNet += item.netOutstanding;

        const excessDisplay = item.excessPayment < 0 
          ? `(${formatAmount(Math.abs(item.excessPayment))})` 
          : formatAmount(item.excessPayment);
        const excessClass = item.excessPayment < 0 ? 'amount payment' : 'amount';

        html += `<tr>
          <td><a class="site-link" onclick="showCollectorSites('${item.collector}')">${item.collector}</a></td>
          <td class="amount">${item.sites.length}</td>
          <td class="amount">${formatAmount(item.totalOutstanding)}</td>
          <td class="${excessClass}">${excessDisplay}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.netOutstanding)}</td>
        </tr>`;
      });

      const totalExcessDisplay = totalExcess < 0 
        ? `(${formatAmount(Math.abs(totalExcess))})` 
        : formatAmount(totalExcess);

      html += `<tr class="total-row">
        <td style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${summaryArray.reduce((sum, item) => sum + item.sites.length, 0)}</td>
        <td class="amount">${formatAmount(totalOutstanding)}</td>
        <td class="amount payment">${totalExcessDisplay}</td>
        <td class="amount">${formatAmount(totalNet)}</td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
          <div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-user-cog"></i> Total Collectors</h3>
          <div class="amount-big">${summaryArray.length}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadCollectorSummaryPDF()"><i class="fas fa-file-pdf"></i> Download as PDF</button>
        <button class="download-button excel" onclick="downloadCollectorSummaryExcel()"><i class="fas fa-file-excel"></i> Download as Excel</button>
      </div>`;

      html += `<div style="text-align: center;">
        <button class="go-back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Go Back</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadCollectorSummaryPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('Invoice Management System', 40, 40);
      doc.setFontSize(12);
      doc.text('Outstanding Collector Wise', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('Collector Outstanding Summary.pdf');
    }

    function downloadCollectorSummaryExcel() {
      const wb = XLSX.utils.book_new();
      
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const wsData = [];
      
      wsData.push(['Invoice Management System']);
      wsData.push(['Outstanding Collector Wise']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      wsData.push([
        'Collector', 
        'Site Count', 
        'Total Outstanding (Rs.)', 
        'Excess Payment (Rs.)', 
        'Net Outstanding (Rs.)'
      ]);
      
      const summaryTable = document.querySelector('#results table tbody');
      if (summaryTable) {
        const rows = Array.from(summaryTable.rows).slice(0, -1);
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        const totalsRow = summaryTable.rows[summaryTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            if (i >= 2 && i <= 4) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [
        { wch: 35 }, 
        { wch: 15 }, 
        { wch: 22 }, 
        { wch: 22 }, 
        { wch: 25 }
      ];
      ws['!cols'] = colWidths;
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            }
          }
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } });
            }
          }
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      XLSX.utils.book_append_sheet(wb, ws, "Collector Summary");
      
      const fileName = `Collector Outstanding Summary_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function showAgeAnalysis() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading age analysis data...</div>`;

      const rows = await fetchSheetData();
      const customerAgeData = {};

      rows.forEach(row => {
        const customerName = row.c[0]?.v?.toString() || '';
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
        const invoiceBalance = row.c[11]?.v || 0;
        const date = row.c[9]?.f || row.c[9]?.v || '';

        if (!customerName || !siteNo) return;

        const customerKey = `${customerName} (${siteNo})`;

        if (!customerAgeData[customerKey]) {
          customerAgeData[customerKey] = {
            customerName,
            siteNo,
            '0-30': 0,
            '31-60': 0,
            '61-90': 0,
            '91-180': 0,
            '181-360': 0,
            '>360': 0,
            total: 0
          };
        }

        const age = calculateAge(date);
        const bracket = getAgeBracket(age);
        
        let amount = invoiceBalance;
        if (invoiceType === 'payment') {
          amount = -Math.abs(invoiceBalance);
        }
        
        customerAgeData[customerKey][bracket] += amount;
        customerAgeData[customerKey].total += amount;
      });

      const ageAnalysisArray = Object.entries(customerAgeData).map(([key, data]) => ({
        key,
        ...data
      })).filter(item => item.total !== 0);

      rawAgeAnalysisData = ageAnalysisArray;
      const sortedData = sortData([...ageAnalysisArray], currentSortType);
      
      // Save current state to navigation history
      navigationHistory.push({
        view: 'ageAnalysis',
        sortType: currentSortType,
        data: sortedData
      });
      
      previousView = currentView;
      currentView = 'ageAnalysis';
      isWithoutExcessView = false;

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No outstanding invoices found for age analysis.</div>`;
        return;
      }

      renderAgeAnalysis(sortedData);
    }

    function renderAgeAnalysis(data) {
      const resultsDiv = document.getElementById('results');
      const ageAnalysisArray = data;

      let total0_30 = 0;
      let total31_60 = 0;
      let total61_90 = 0;
      let total91_180 = 0;
      let total181_360 = 0;
      let totalOver360 = 0;
      let grandTotal = 0;

      let html = renderSortButtons('ageAnalysis');
      html += `<div class="section-title"><i class="fas fa-clock"></i> Age Analysis (Customer Wise)</div>
               <div class="age-table">
               <table>
                 <thead>
                   <tr>
                     <th>Customer Name</th>
                     <th>Site No</th>
                     <th class="age-header">0-30 Days</th>
                     <th class="age-header">31-60 Days</th>
                     <th class="age-header">61-90 Days</th>
                     <th class="age-header">91-180 Days</th>
                     <th class="age-header">181-360 Days</th>
                     <th class="age-header">>360 Days</th>
                     <th>Total Outstanding</th>
                   </tr>
                 </thead>
                 <tbody>`;

      ageAnalysisArray.forEach(item => {
        total0_30 += item['0-30'];
        total31_60 += item['31-60'];
        total61_90 += item['61-90'];
        total91_180 += item['91-180'];
        total181_360 += item['181-360'];
        totalOver360 += item['>360'];
        grandTotal += item.total;

        html += `<tr>
          <td>${item.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteNo('${item.siteNo}')">${item.siteNo}</a></td>
          <td class="amount">${formatAmount(item['0-30'])}</td>
          <td class="amount">${formatAmount(item['31-60'])}</td>
          <td class="amount">${formatAmount(item['61-90'])}</td>
          <td class="amount">${formatAmount(item['91-180'])}</td>
          <td class="amount">${formatAmount(item['181-360'])}</td>
          <td class="amount">${formatAmount(item['>360'])}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.total)}</td>
        </tr>`;
      });

      html += `<tr class="total-row">
        <td colspan="2" style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${formatAmount(total0_30)}</td>
        <td class="amount">${formatAmount(total31_60)}</td>
        <td class="amount">${formatAmount(total61_90)}</td>
        <td class="amount">${formatAmount(total91_180)}</td>
        <td class="amount">${formatAmount(total181_360)}</td>
        <td class="amount">${formatAmount(totalOver360)}</td>
        <td class="amount">${formatAmount(grandTotal)}</td>
      </tr>`;

      html += `</tbody></table></div>`;

      // Calculate percentages for each age bucket
      const percent0_30 = grandTotal !== 0 ? ((total0_30 / grandTotal) * 100).toFixed(1) : 0;
      const percent31_60 = grandTotal !== 0 ? ((total31_60 / grandTotal) * 100).toFixed(1) : 0;
      const percent61_90 = grandTotal !== 0 ? ((total61_90 / grandTotal) * 100).toFixed(1) : 0;
      const percent91_180 = grandTotal !== 0 ? ((total91_180 / grandTotal) * 100).toFixed(1) : 0;
      const percent181_360 = grandTotal !== 0 ? ((total181_360 / grandTotal) * 100).toFixed(1) : 0;
      const percentOver360 = grandTotal !== 0 ? ((totalOver360 / grandTotal) * 100).toFixed(1) : 0;

      html += `<div class="summary-totals">
        <div class="age-summary-card days-0-30">
          <h3><i class="fas fa-hourglass-start"></i> 0-30 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total0_30)}</div>
          <div class="percentage">${percent0_30}% of Total</div>
        </div>
        <div class="age-summary-card days-31-60">
          <h3><i class="fas fa-hourglass-half"></i> 31-60 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total31_60)}</div>
          <div class="percentage">${percent31_60}% of Total</div>
        </div>
        <div class="age-summary-card days-61-90">
          <h3><i class="fas fa-hourglass-end"></i> 61-90 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total61_90)}</div>
          <div class="percentage">${percent61_90}% of Total</div>
        </div>
        <div class="age-summary-card days-91-180">
          <h3><i class="fas fa-calendar-week"></i> 91-180 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total91_180)}</div>
          <div class="percentage">${percent91_180}% of Total</div>
        </div>
        <div class="age-summary-card days-181-360">
          <h3><i class="fas fa-calendar-alt"></i> 181-360 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total181_360)}</div>
          <div class="percentage">${percent181_360}% of Total</div>
        </div>
        <div class="age-summary-card days-360-plus">
          <h3><i class="fas fa-calendar-times"></i> >360 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(totalOver360)}</div>
          <div class="percentage">${percentOver360}% of Total</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-chart-line"></i> Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(grandTotal)}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadAgeAnalysisPDF()"><i class="fas fa-file-pdf"></i> Download as PDF</button>
        <button class="download-button excel" onclick="downloadAgeAnalysisExcel()"><i class="fas fa-file-excel"></i> Download as Excel</button>
      </div>`;

      html += `<div style="text-align: center;">
        <button class="go-back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Go Back</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadAgeAnalysisPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('Invoice Management System', 40, 40);
      doc.setFontSize(12);
      doc.text('Age Analysis (Customer Wise)', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results .age-table table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' },
          5: { halign: 'right' },
          6: { halign: 'right' },
          7: { halign: 'right' },
          8: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('Age Analysis.pdf');
    }

    function downloadAgeAnalysisExcel() {
      const wb = XLSX.utils.book_new();
      
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const wsData = [];
      
      wsData.push(['Invoice Management System']);
      wsData.push(['Age Analysis (Customer Wise)']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      wsData.push([
        'Customer Name', 
        'Site No', 
        '0-30 Days', 
        '31-60 Days', 
        '61-90 Days', 
        '91-180 Days', 
        '181-360 Days', 
        '>360 Days', 
        'Total Outstanding'
      ]);
      
      const ageAnalysisTable = document.querySelector('#results .age-table tbody');
      if (ageAnalysisTable) {
        const rows = Array.from(ageAnalysisTable.rows).slice(0, -1);
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            if (i >= 2 && i <= 8) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        const totalsRow = ageAnalysisTable.rows[ageAnalysisTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            if (i >= 2 && i <= 8) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [
        { wch: 35 }, 
        { wch: 15 }, 
        { wch: 18 }, 
        { wch: 18 }, 
        { wch: 18 }, 
        { wch: 18 }, 
        { wch: 18 }, 
        { wch: 18 }, 
        { wch: 22 }
      ];
      ws['!cols'] = colWidths;
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } });
            }
          }
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 8 } });
            }
          }
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 8 } });
            }
          }
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 8) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            if (C >= 2 && C <= 8) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 8) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            if (C >= 2 && C <= 8) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      XLSX.utils.book_append_sheet(wb, ws, "Age Analysis");
      
      const fileName = `Age Analysis_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function showInvoicesByAge(ageRange) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading invoices for ${ageRange} days...</div>`;
      
      currentAgeFilter = ageRange;
      
      // Check if we already have this data cached
      if (rawAgeFilterData[ageRange]) {
        const sortedData = sortData([...rawAgeFilterData[ageRange]], currentSortType);
        
        // Save current state to navigation history
        navigationHistory.push({
          view: 'ageFilter',
          sortType: currentSortType,
          data: sortedData,
          ageRange: ageRange
        });
        
        previousView = currentView;
        currentView = 'ageFilter';
        
        renderInvoicesByAge(sortedData, ageRange);
        return;
      }
      
      const rows = await fetchSheetData();
      const invoices = [];
      
      rows.forEach(row => {
        const customerName = row.c[0]?.v?.toString() || '';
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const siteName = row.c[2]?.v?.toString() || '';
        const newVO = row.c[4]?.v?.toString() || '';
        const sm = row.c[5]?.v?.toString() || '';
        const om = row.c[6]?.v?.toString() || '';
        const collector = row.c[7]?.v?.toString() || '';
        const invoiceNo = row.c[8]?.v || '';
        const date = row.c[9]?.f || row.c[9]?.v || '';
        const invoiceType = row.c[10]?.v?.toString() || '';
        const invoiceBalance = row.c[11]?.v || 0;
        
        if (!customerName || !siteNo) return;
        
        const age = calculateAge(date);
        const bracket = getAgeBracket(age);
        
        // Check if this invoice falls into the requested age range
        let includeInvoice = false;
        
        if (ageRange === '0-30' && bracket === '0-30') {
          includeInvoice = true;
        } else if (ageRange === '31-60' && bracket === '31-60') {
          includeInvoice = true;
        } else if (ageRange === '61-90' && bracket === '61-90') {
          includeInvoice = true;
        } else if (ageRange === '91-180' && bracket === '91-180') {
          includeInvoice = true;
        } else if (ageRange === '181-360' && bracket === '181-360') {
          includeInvoice = true;
        } else if (ageRange === '360-plus' && bracket === '>360') {
          includeInvoice = true;
        }
        
        // For excess payments, use the same age calculation
        if (invoiceType.toLowerCase() === 'payment') {
          const paymentAge = calculateAge(date);
          const paymentBracket = getAgeBracket(paymentAge);
          
          // Include excess payments in the appropriate age bucket based on their date
          if ((ageRange === '0-30' && paymentBracket === '0-30') ||
              (ageRange === '31-60' && paymentBracket === '31-60') ||
              (ageRange === '61-90' && paymentBracket === '61-90') ||
              (ageRange === '91-180' && paymentBracket === '91-180') ||
              (ageRange === '181-360' && paymentBracket === '181-360') ||
              (ageRange === '360-plus' && paymentBracket === '>360')) {
            includeInvoice = true;
          }
        }
        
        if (includeInvoice) {
          invoices.push({
            customerName,
            siteNo,
            siteName,
            newVO,
            sm,
            om,
            collector,
            invoiceNo,
            date,
            invoiceType,
            invoiceBalance,
            age,
            ageBracket: bracket
          });
        }
      });
      
      // Cache the data for this age range
      rawAgeFilterData[ageRange] = invoices;
      
      const sortedData = sortData([...invoices], currentSortType);
      
      // Save current state to navigation history
      navigationHistory.push({
        view: 'ageFilter',
        sortType: currentSortType,
        data: sortedData,
        ageRange: ageRange
      });
      
      previousView = currentView;
      currentView = 'ageFilter';
      
      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No invoices found for ${ageRange} days.</div>`;
        return;
      }
      
      renderInvoicesByAge(sortedData, ageRange);
    }

    function renderInvoicesByAge(data, ageRange) {
      const resultsDiv = document.getElementById('results');
      const invoices = data;
      
      let totalAmount = 0;
      
      let html = renderSortButtons('ageFilter');
      
      // Add title based on age range
      let titleText = '';
      let titleIcon = '';
      let titleColor = '';
      
      switch(ageRange) {
        case '0-30':
          titleText = 'Invoices & Excess Payments (0-30 Days)';
          titleIcon = 'fa-hourglass-start';
          titleColor = '#38a169';
          break;
        case '31-60':
          titleText = 'Invoices & Excess Payments (31-60 Days)';
          titleIcon = 'fa-hourglass-half';
          titleColor = '#d69e2e';
          break;
        case '61-90':
          titleText = 'Invoices & Excess Payments (61-90 Days)';
          titleIcon = 'fa-hourglass-end';
          titleColor = '#dd6b20';
          break;
        case '91-180':
          titleText = 'Invoices & Excess Payments (91-180 Days)';
          titleIcon = 'fa-calendar-week';
          titleColor = '#e53e3e';
          break;
        case '181-360':
          titleText = 'Invoices & Excess Payments (181-360 Days)';
          titleIcon = 'fa-calendar-alt';
          titleColor = '#9f1239';
          break;
        case '360-plus':
          titleText = 'Invoices & Excess Payments (More than 360 Days)';
          titleIcon = 'fa-calendar-times';
          titleColor = '#7c2d12';
          break;
      }
      
      html += `<div class="section-title" style="border-bottom-color: ${titleColor};">
                <i class="fas ${titleIcon}" style="color: ${titleColor};"></i> 
                ${titleText}
              </div>`;
      
      // Separate outstanding invoices and excess payments
      const outstandingInvoices = invoices.filter(inv => !inv.invoiceType.toLowerCase().includes('payment'));
      const excessPayments = invoices.filter(inv => inv.invoiceType.toLowerCase().includes('payment'));
      
      // Sort outstanding invoices by age (largest to smallest)
      outstandingInvoices.sort((a, b) => {
        const ageA = calculateAge(a.date);
        const ageB = calculateAge(b.date);
        return ageB - ageA; // Sort by age descending
      });
      
      // Sort excess payments by date (newest to oldest)
      excessPayments.sort((a, b) => {
        const dateA = parseDate(a.date);
        const dateB = parseDate(b.date);
        return dateB - dateA; // Sort by date descending
      });
      
      html += `<table>
                <thead>
                  <tr>
                    <th>Customer Name</th>
                    <th>Site No</th>
                    <th>Site Name</th>
                    <th>New VO</th>
                    <th>SM</th>
                    <th>OM</th>
                    <th>Collector</th>
                    <th>Invoice No</th>
                    <th>Date</th>
                    <th>Invoice Type</th>
                    <th>Amount (Rs.)</th>
                    <th>Age (Days)</th>
                  </tr>
                </thead>
                <tbody>`;
      
      // Display outstanding invoices first
      outstandingInvoices.forEach(invoice => {
        const isPayment = invoice.invoiceType.toLowerCase().includes('payment');
        const displayAmount = isPayment ? `(${formatAmount(Math.abs(invoice.invoiceBalance))})` : formatAmount(invoice.invoiceBalance);
        const amountClass = isPayment ? 'amount payment' : 'amount';
        totalAmount += invoice.invoiceBalance;
        
        html += `<tr>
          <td>${invoice.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteNo('${invoice.siteNo}')">${invoice.siteNo}</a></td>
          <td>${invoice.siteName}</td>
          <td>${invoice.newVO}</td>
          <td>${invoice.sm}</td>
          <td>${invoice.om}</td>
          <td>${invoice.collector}</td>
          <td><a class="invoice-link" onclick="showInvoiceDetails('${invoice.invoiceNo}', '${invoice.siteNo}')">${invoice.invoiceNo}</a></td>
          <td>${invoice.date}</td>
          <td>${invoice.invoiceType}</td>
          <td class="${amountClass}">${displayAmount}</td>
          <td class="overdue ${getAgeClass(invoice.ageBracket)}">${invoice.age}</td>
        </tr>`;
      });
      
      // Add separator if there are both outstanding invoices and excess payments
      if (outstandingInvoices.length > 0 && excessPayments.length > 0) {
        html += `<tr class="payment-separator">
          <td colspan="13" style="text-align: center; font-weight: 700; color: #38a169; background-color: #f0f8ff;">
            <i class="fas fa-hand-holding-usd"></i> Excess Payments
          </td>
        </tr>`;
      }
      
      // Display excess payments
      excessPayments.forEach(invoice => {
        const isPayment = invoice.invoiceType.toLowerCase().includes('payment');
        const displayAmount = isPayment ? `(${formatAmount(Math.abs(invoice.invoiceBalance))})` : formatAmount(invoice.invoiceBalance);
        const amountClass = isPayment ? 'amount payment' : 'amount';
        totalAmount += invoice.invoiceBalance;
        
        html += `<tr>
          <td>${invoice.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteNo('${invoice.siteNo}')">${invoice.siteNo}</a></td>
          <td>${invoice.siteName}</td>
          <td>${invoice.newVO}</td>
          <td>${invoice.sm}</td>
          <td>${invoice.om}</td>
          <td>${invoice.collector}</td>
          <td><a class="invoice-link" onclick="showInvoiceDetails('${invoice.invoiceNo}', '${invoice.siteNo}')">${invoice.invoiceNo}</a></td>
          <td>${invoice.date}</td>
          <td>${invoice.invoiceType}</td>
          <td class="${amountClass}">${displayAmount}</td>
          <td class="overdue ${getAgeClass(invoice.ageBracket)}">${invoice.age}</td>
        </tr>`;
      });
      
      html += `<tr class="total-row">
        <td colspan="11" style="text-align: right;">TOTAL</td>
        <td class="amount">${formatAmount(totalAmount)}</td>
        <td></td>
      </tr>`;
      
      html += `</tbody></table>`;
      
      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3><i class="fas fa-file-invoice"></i> Total Amount</h3>
          <div class="amount-big">Rs. ${formatAmount(totalAmount)}</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-list"></i> Number of Records</h3>
          <div class="amount-big">${invoices.length}</div>
        </div>
      </div>`;
      
      html += `<div class="download-container">
        <button class="download-button" onclick="downloadAgeFilterPDF('${ageRange}')">
          <i class="fas fa-file-pdf"></i> Download as PDF
        </button>
        <button class="download-button excel" onclick="downloadAgeFilterExcel('${ageRange}')">
          <i class="fas fa-file-excel"></i> Download as Excel
        </button>
      </div>`;
      
      html += `<div style="text-align: center;">
        <button class="go-back-btn" onclick="goBack()">
          <i class="fas fa-arrow-left"></i> Go Back
        </button>
      </div>`;
      
      resultsDiv.innerHTML = html;
    }

    function downloadAgeFilterPDF(ageRange) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
      
      let titleText = '';
      switch(ageRange) {
        case '0-30':
          titleText = 'Invoices & Excess Payments (0-30 Days)';
          break;
        case '31-60':
          titleText = 'Invoices & Excess Payments (31-60 Days)';
          break;
        case '61-90':
          titleText = 'Invoices & Excess Payments (61-90 Days)';
          break;
        case '91-180':
          titleText = 'Invoices & Excess Payments (91-180 Days)';
          break;
        case '181-360':
          titleText = 'Invoices & Excess Payments (181-360 Days)';
          break;
        case '360-plus':
          titleText = 'Invoices & Excess Payments (More than 360 Days)';
          break;
      }
      
      doc.setFontSize(14);
      doc.text('Invoice Management System', 40, 40);
      doc.setFontSize(12);
      doc.text(titleText, 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);
      
      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          11: { halign: 'right' },
          12: { halign: 'center' }
        },
        margin: { left: 40, right: 40 },
      });
      
      doc.save(`${titleText}.pdf`);
    }

    function downloadAgeFilterExcel(ageRange) {
      const wb = XLSX.utils.book_new();
      
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      let titleText = '';
      switch(ageRange) {
        case '0-30':
          titleText = 'Invoices & Excess Payments (0-30 Days)';
          break;
        case '31-60':
          titleText = 'Invoices & Excess Payments (31-60 Days)';
          break;
        case '61-90':
          titleText = 'Invoices & Excess Payments (61-90 Days)';
          break;
        case '91-180':
          titleText = 'Invoices & Excess Payments (91-180 Days)';
          break;
        case '181-360':
          titleText = 'Invoices & Excess Payments (181-360 Days)';
          break;
        case '360-plus':
          titleText = 'Invoices & Excess Payments (More than 360 Days)';
          break;
      }
      
      const wsData = [];
      
      wsData.push(['Invoice Management System']);
      wsData.push([titleText]);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      wsData.push([
        'Customer Name', 
        'Site No', 
        'Site Name', 
        'New VO', 
        'SM', 
        'OM', 
        'Collector', 
        'Invoice No', 
        'Date', 
        'Invoice Type', 
        'Amount (Rs.)', 
        'Age (Days)'
      ]);
      
      const table = document.querySelector('#results table tbody');
      if (table) {
        const rows = Array.from(table.rows).slice(0, -1);
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            if (i === 11) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        const totalsRow = table.rows[table.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            if (i === 11) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [
        { wch: 35 }, 
        { wch: 15 }, 
        { wch: 25 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 15 }, 
        { wch: 15 }, 
        { wch: 20 }, 
        { wch: 15 }
      ];
      ws['!cols'] = colWidths;
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 12 } });
            }
          }
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 12 } });
            }
          }
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 12 } });
            }
          }
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C === 11) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            if (C === 11) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C === 11) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            if (C === 11) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      XLSX.utils.book_append_sheet(wb, ws, titleText);
      
      const fileName = `${titleText}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    // Initialize application
    window.onload = async function() {
      // First fetch user credentials from Google Sheet
      await fetchUsers();
      
      // Check if user is already logged in
      checkLoginStatus();
    };
      async function searchBySiteNo(siteNo = null) {
      const input = (siteNo || document.getElementById('siteNoInput').value.trim().toUpperCase());
      currentSiteNo = input;
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> Please enter a site number to search.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading data...</div>`;

      const rows = await fetchSheetData();
      const invoices = [];

      rows.forEach(row => {
        const siteNoFromSheet = row.c[1]?.v?.toString().toUpperCase() || '';
        if (siteNoFromSheet === input) {
          const customerName = row.c[0]?.v || '';
          const siteName = row.c[2]?.v || '';
          const newVO = row.c[4]?.v || '';
          const sm = row.c[5]?.v || '';
          const om = row.c[6]?.v || '';
          const collector = row.c[7]?.v || '';
          const invoiceNo = row.c[8]?.v || '';
          const date = row.c[9]?.f || row.c[9]?.v || '';
          const invoiceType = row.c[10]?.v || '';
          const invoiceBalance = row.c[11]?.v || 0;
          
          invoices.push({
            customerName,
            siteNo: siteNoFromSheet,
            siteName,
            newVO,
            sm,
            om,
            collector,
            invoiceNo,
            date,
            invoiceType,
            invoiceBalance
          });
        }
      });

      if (invoices.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No invoices found for Site No: <strong>${input}</strong></div>`;
        return;
      }

      // Sort invoices by age (largest to smallest for outstanding invoices, newest to oldest for excess payments)
      const sortedInvoices = sortInvoicesByAge(invoices);

      let html = `<div class="site-code-header"><i class="fas fa-map-marker-alt"></i> Site No: ${input}</div>`;
      let total = 0;

      // Separate outstanding invoices and excess payments
      const outstandingInvoices = sortedInvoices.filter(inv => !inv.invoiceType.toLowerCase().includes('payment'));
      const excessPayments = sortedInvoices.filter(inv => inv.invoiceType.toLowerCase().includes('payment'));

      html += `<table>
                <thead>
                  <tr>
                    <th>Customer Name</th>
                    <th>Site Name</th>
                    <th>New VO</th>
                    <th>SM</th>
                    <th>OM</th>
                    <th>Collector</th>
                    <th>Invoice No / Ref</th>
                    <th>Date</th>
                    <th>Invoice Type</th>
                    <th>Amount (Rs.)</th>
                    <th>Age (Days)</th>
                  </tr>
                </thead>
                <tbody>`;

      // Display outstanding invoices first
      outstandingInvoices.forEach(invoice => {
        const isPayment = invoice.invoiceType.toLowerCase().includes('payment');
        const displayAmount = isPayment ? `(${formatAmount(Math.abs(invoice.invoiceBalance))})` : formatAmount(invoice.invoiceBalance);
        const amountClass = isPayment ? 'amount payment' : 'amount';
        total += invoice.invoiceBalance;
        
        const age = calculateAge(invoice.date);
        const ageClass = getAgeClass(getAgeBracket(age));

        html += `<tr>
          <td>${invoice.customerName}</td>
          <td>${invoice.siteName}</td>
          <td>${invoice.newVO}</td>
          <td>${invoice.sm}</td>
          <td>${invoice.om}</td>
          <td>${invoice.collector}</td>
          <td><a class="invoice-link" onclick="showInvoiceDetails('${invoice.invoiceNo}', '${invoice.siteNo}')">${invoice.invoiceNo}</a></td>
          <td>${invoice.date}</td>
          <td>${invoice.invoiceType}</td>
          <td class="${amountClass}">${displayAmount}</td>
          <td class="overdue ${ageClass}">${age}</td>
        </tr>`;
      });

      // Add separator if there are both outstanding invoices and excess payments
      if (outstandingInvoices.length > 0 && excessPayments.length > 0) {
        html += `<tr class="payment-separator">
          <td colspan="12" style="text-align: center; font-weight: 700; color: #38a169; background-color: #f0f8ff;">
            <i class="fas fa-hand-holding-usd"></i> Excess Payments
          </td>
        </tr>`;
      }

      // Display excess payments
      excessPayments.forEach(invoice => {
        const isPayment = invoice.invoiceType.toLowerCase().includes('payment');
        const displayAmount = isPayment ? `(${formatAmount(Math.abs(invoice.invoiceBalance))})` : formatAmount(invoice.invoiceBalance);
        const amountClass = isPayment ? 'amount payment' : 'amount';
        total += invoice.invoiceBalance;
        
        const age = calculateAge(invoice.date);
        const ageClass = getAgeClass(getAgeBracket(age));

        html += `<tr>
          <td>${invoice.customerName}</td>
          <td>${invoice.siteName}</td>
          <td>${invoice.newVO}</td>
          <td>${invoice.sm}</td>
          <td>${invoice.om}</td>
          <td>${invoice.collector}</td>
          <td><a class="invoice-link" onclick="showInvoiceDetails('${invoice.invoiceNo}', '${invoice.siteNo}')">${invoice.invoiceNo}</a></td>
          <td>${invoice.date}</td>
          <td>${invoice.invoiceType}</td>
          <td class="${amountClass}">${displayAmount}</td>
          <td class="overdue ${ageClass}">${age}</td>
        </tr>`;
      });

      // Add total row after the last excess payment or invoice, not after the age column
      html += `<tr class="total-row">
        <td colspan="10" style="text-align: right;">Total Outstanding</td>
        <td class="amount" style="font-weight: 700;">${formatAmount(total)}</td>
        <td></td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadSiteNoPDF()">
          <i class="fas fa-file-pdf"></i> Download as PDF
        </button>
        <button class="download-button excel" onclick="downloadSiteNoExcel()">
          <i class="fas fa-file-excel"></i> Download as Excel
        </button>
      </div>`;

      html += `<div style="text-align: center;">
        <button class="go-back-btn" onclick="goBack()">
          <i class="fas fa-arrow-left"></i> Go Back
        </button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadSiteNoPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('Invoice Management System', 40, 40);
      doc.setFontSize(12);
      doc.text('Site Details', 40, 60);
      if (currentSiteNo) {
        doc.text(`Site No: ${currentSiteNo}`, 40, 80);
      }
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 100);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 120,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 4, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          10: { halign: 'right' },
          11: { halign: 'center' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save(`Site ${currentSiteNo} Details.pdf`);
    }

    function downloadSiteNoExcel() {
      const wb = XLSX.utils.book_new();
      
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const wsData = [];
      
      wsData.push(['Invoice Management System']);
      wsData.push([`Site Details - Site No: ${currentSiteNo}`]);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      wsData.push([
        'Customer Name', 
        'Site Name', 
        'New VO', 
        'SM', 
        'OM', 
        'Collector', 
        'Invoice No / Ref', 
        'Date', 
        'Invoice Type', 
        'Amount (Rs.)', 
        'Age (Days)'
      ]);
      
      const table = document.querySelector('#results table tbody');
      if (table) {
        const rows = Array.from(table.rows).slice(0, -1);
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            if (i === 10) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        const totalsRow = table.rows[table.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            if (i === 10) {
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [
        { wch: 35 }, 
        { wch: 25 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 20 }, 
        { wch: 15 }, 
        { wch: 15 }, 
        { wch: 20 }, 
        { wch: 15 }
      ];
      ws['!cols'] = colWidths;
      
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 11 } });
            }
          }
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 11 } });
            }
          }
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 11 } });
            }
          }
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C === 10) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            if (C === 10) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C === 10) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            if (C === 10) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      XLSX.utils.book_append_sheet(wb, ws, `Site ${currentSiteNo} Details`);
      
      const fileName = `Site ${currentSiteNo} Details_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function searchByInvoiceNo() {
      const input = document.getElementById('invoiceNoInput').value.trim();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> Please enter an invoice number to search.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading data...</div>`;

      const rows = await fetchSheetData();
      let found = null;

      rows.forEach(row => {
        const invoiceNo = row.c[8]?.v?.toString().toUpperCase() || '';
        if (invoiceNo === input.toUpperCase()) {
          found = {
            customerName: row.c[0]?.v || '',
            siteNo: row.c[1]?.v || '',
            siteName: row.c[2]?.v || '',
            newVO: row.c[4]?.v || '',
            sm: row.c[5]?.v || '',
            om: row.c[6]?.v || '',
            collector: row.c[7]?.v || '',
            invoiceNo,
            date: row.c[9]?.f || row.c[9]?.v || '',
            invoiceType: row.c[10]?.v || '',
            amount: formatAmount(row.c[11]?.v || 0),
          };
        }
      });

      if (!found) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No invoice found with Invoice Number: <strong>${input}</strong></div>`;
        return;
      }

      let html = `
        <div class="section-title"><i class="fas fa-file-invoice"></i> Invoice Details</div>
        <table>
          <thead>
            <tr>
              <th>Customer Name</th>
              <th>Site No</th>
              <th>Site Name</th>
              <th>New VO</th>
              <th>SM</th>
              <th>OM</th>
              <th>Collector</th>
              <th>Invoice No</th>
              <th>Date</th>
              <th>Invoice Type</th>
              <th>Amount (Rs.)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${found.customerName}</td>
              <td><a class="site-link" onclick="searchBySiteNo('${found.siteNo}')">${found.siteNo}</a></td>
              <td>${found.siteName}</td>
              <td>${found.newVO}</td>
              <td>${found.sm}</td>
              <td>${found.om}</td>
              <td>${found.collector}</td>
              <td><a class="invoice-link" onclick="showInvoiceDetails('${found.invoiceNo}', '${found.siteNo}')">${found.invoiceNo}</a></td>
              <td>${found.date}</td>
              <td>${found.invoiceType}</td>
              <td class="amount">${found.amount}</td>
            </tr>
          </tbody>
        </table>
      `;
      resultsDiv.innerHTML = html;
    }

    async function searchByCustomerName() {
      const input = document.getElementById('customerNameInput').value.trim().toLowerCase();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> Please enter part of a customer name.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading data...</div>`;

      const rows = await fetchSheetData();
      const matches = new Map(); // Using Map to store unique site numbers with their data

      rows.forEach(row => {
        const customerName = row.c[0]?.v?.toString() || '';
        const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
        const siteName = row.c[2]?.v?.toString() || '';
        const invoiceType = row.c[10]?.v?.toString() || '';
        const invoiceBalance = row.c[11]?.v || 0;
        
        if (customerName.toLowerCase().includes(input)) {
          if (!matches.has(siteNo)) {
            matches.set(siteNo, {
              siteNo,
              siteName,
              customerName,
              outstanding: 0,
              excessPayment: 0
            });
          }
          
          const siteData = matches.get(siteNo);
          
          if (invoiceType.toLowerCase() === 'payment') {
            siteData.excessPayment += invoiceBalance;
          } else {
            siteData.outstanding += invoiceBalance;
          }
        }
      });

      if (matches.size === 0) {
        resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No sites found for Customer Name containing: <strong>${input}</strong></div>`;
        return;
      }

      let html = `<div class="section-title"><i class="fas fa-users"></i> Matching Sites</div><table><thead><tr>
        <th>Customer Name</th><th>Site No</th><th>Site Name</th><th>Outstanding (Rs.)</th><th>Excess Payment (Rs.)</th><th>Net Outstanding (Rs.)</th></tr></thead><tbody>`;

      matches.forEach(m => {
        const netOutstanding = m.outstanding + m.excessPayment;
        const excessDisplay = m.excessPayment < 0 
          ? `(${formatAmount(Math.abs(m.excessPayment))})`
          : formatAmount(m.excessPayment);
        const excessClass = m.excessPayment < 0 ? 'amount payment' : 'amount';

        html += `<tr>
<td>${m.customerName}</td>
<td><a class="site-link" onclick="searchBySiteNo('${m.siteNo}')">${m.siteNo}</a></td>
<td>${m.siteName}</td>
<td class="amount">${formatAmount(m.outstanding)}</td>
<td class="${excessClass}">${excessDisplay}</td>
<td class="amount" style="font-weight: 700;">${formatAmount(netOutstanding)}</td>
</tr>`;
});

html += `</tbody></table>`;
resultsDiv.innerHTML = html;
}

// Function to show invoice details in modal
async function showInvoiceDetails(invoiceNo, siteNo) {
const modal = document.getElementById('invoiceModal');
const modalBody = document.getElementById('invoiceModalBody');

// Show loading state
modalBody.innerHTML = `
<div style="text-align: center; padding: 40px 0;">
<i class="fas fa-spinner fa-spin fa-3x"></i>
<p style="margin-top: 20px;">Loading invoice details...</p>
</div>
`;

modal.style.display = 'block';

try {
const rows = await fetchSheetData();
let invoiceData = null;

// Find invoice with matching invoice number and site number
for (const row of rows) {
const rowInvoiceNo = row.c[8]?.v?.toString() || '';
const rowSiteNo = row.c[1]?.v?.toString().toUpperCase() || '';

if (rowInvoiceNo === invoiceNo && rowSiteNo === siteNo) {
invoiceData = {
customerName: row.c[0]?.v || '',
siteNo: rowSiteNo,
siteName: row.c[2]?.v || '',
newVO: row.c[4]?.v || '',
sm: row.c[5]?.v || '',
om: row.c[6]?.v || '',
collector: row.c[7]?.v || '',
invoiceNo: rowInvoiceNo,
date: row.c[9]?.f || row.c[9]?.v || '',
invoiceType: row.c[10]?.v || '',
invoiceBalance: row.c[11]?.v || 0
};
break;
}
}

if (!invoiceData) {
modalBody.innerHTML = `
<div class="not-found">
<i class="fas fa-exclamation-circle"></i>
Invoice details not found.
</div>
`;
return;
}

// Build HTML for modal body
let html = `
<div class="invoice-details">
<div class="detail-item">
<div class="detail-label">Invoice Number</div>
<div class="detail-value">${invoiceData.invoiceNo}</div>
</div>
<div class="detail-item">
<div class="detail-label">Customer Name</div>
<div class="detail-value">${invoiceData.customerName}</div>
</div>
<div class="detail-item">
<div class="detail-label">Site No</div>
<div class="detail-value">${invoiceData.siteNo}</div>
</div>
<div class="detail-item">
<div class="detail-label">Site Name</div>
<div class="detail-value">${invoiceData.siteName}</div>
</div>
<div class="detail-item">
<div class="detail-label">New VO</div>
<div class="detail-value">${invoiceData.newVO}</div>
</div>
<div class="detail-item">
<div class="detail-label">SM</div>
<div class="detail-value">${invoiceData.sm}</div>
</div>
<div class="detail-item">
<div class="detail-label">OM</div>
<div class="detail-value">${invoiceData.om}</div>
</div>
<div class="detail-item">
<div class="detail-label">Collector</div>
<div class="detail-value">${invoiceData.collector}</div>
</div>
<div class="detail-item">
<div class="detail-label">Invoice Date</div>
<div class="detail-value">${invoiceData.date}</div>
</div>
<div class="detail-item">
<div class="detail-label">Invoice Type</div>
<div class="detail-value">${invoiceData.invoiceType}</div>
</div>
</div>

<div class="outstanding-amount">
<div class="label">Outstanding Amount</div>
<div class="value">Rs. ${formatAmount(invoiceData.invoiceBalance)}</div>
</div>
`;

modalBody.innerHTML = html;
} catch (error) {
console.error('Error fetching invoice details:', error);
modalBody.innerHTML = `
<div class="not-found">
<i class="fas fa-exclamation-triangle"></i>
Error loading invoice details. Please try again.
</div>
`;
}
}

function closeInvoiceModal() {
document.getElementById('invoiceModal').style.display = 'none';
}

// Function to show sites for a customer
async function showCustomerSites(customerName) {
const resultsDiv = document.getElementById('results');
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading sites for ${customerName}...</div>`;

const rows = await fetchSheetData();
const sites = [];

rows.forEach(row => {
const rowCustomerName = row.c[0]?.v?.toString() || '';
const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
const siteName = row.c[2]?.v?.toString() || '';
const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
const invoiceBalance = row.c[11]?.v || 0;

if (rowCustomerName === customerName && siteNo) {
const existingSite = sites.find(site => site.siteNo === siteNo);

if (!existingSite) {
sites.push({
siteNo,
siteName,
outstanding: 0,
excessPayment: 0
});
}

const site = sites.find(site => site.siteNo === siteNo);

if (invoiceType === 'payment') {
site.excessPayment += invoiceBalance;
} else {
site.outstanding += invoiceBalance;
}
}
});

if (sites.length === 0) {
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No sites found for customer: <strong>${customerName}</strong></div>`;
return;
}

let html = `<div class="section-title"><i class="fas fa-map-marker-alt"></i> Sites for ${customerName}</div>
<table>
<thead>
<tr>
<th>Site No</th>
<th>Site Name</th>
<th>Outstanding (Rs.)</th>
<th>Excess Payment (Rs.)</th>
<th>Net Outstanding (Rs.)</th>
</tr>
</thead>
<tbody>`;

let totalOutstanding = 0;
let totalExcess = 0;
let totalNet = 0;

sites.forEach(site => {
const netOutstanding = site.outstanding + site.excessPayment;
const excessDisplay = site.excessPayment < 0
? `(${formatAmount(Math.abs(site.excessPayment))})`
: formatAmount(site.excessPayment);
const excessClass = site.excessPayment < 0 ? 'amount payment' : 'amount';

totalOutstanding += site.outstanding;
totalExcess += site.excessPayment;
totalNet += netOutstanding;

html += `<tr>
<td><a class="site-link" onclick="searchBySiteNo('${site.siteNo}')">${site.siteNo}</a></td>
<td>${site.siteName}</td>
<td class="amount">${formatAmount(site.outstanding)}</td>
<td class="${excessClass}">${excessDisplay}</td>
<td class="amount" style="font-weight: 700;">${formatAmount(netOutstanding)}</td>
</tr>`;
});

const totalExcessDisplay = totalExcess < 0
? `(${formatAmount(Math.abs(totalExcess))})`
: formatAmount(totalExcess);

html += `<tr class="total-row">
<td style="text-align: right;">TOTAL</td>
<td></td>
<td class="amount">${formatAmount(totalOutstanding)}</td>
<td class="amount payment">${totalExcessDisplay}</td>
<td class="amount">${formatAmount(totalNet)}</td>
</tr>`;

html += `</tbody></table>`;

html += `<div class="summary-totals">
<div class="summary-card">
<h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
<div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-map-marker-alt"></i> Total Sites</h3>
<div class="amount-big">${sites.length}</div>
</div>
</div>`;

html += `<div style="text-align: center;">
<button class="go-back-btn" onclick="goBack()">
<i class="fas fa-arrow-left"></i> Go Back
</button>
</div>`;

resultsDiv.innerHTML = html;
}

// Function to show sites for a New VO
async function showNewVOSites(newVO) {
const resultsDiv = document.getElementById('results');
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading sites for ${newVO}...</div>`;

const rows = await fetchSheetData();
const sites = [];

rows.forEach(row => {
const rowNewVO = row.c[4]?.v?.toString() || '';
const customerName = row.c[0]?.v?.toString() || '';
const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
const siteName = row.c[2]?.v?.toString() || '';
const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
const invoiceBalance = row.c[11]?.v || 0;

if (rowNewVO === newVO && siteNo) {
const existingSite = sites.find(site => site.siteNo === siteNo);

if (!existingSite) {
sites.push({
siteNo,
siteName,
customerName,
outstanding: 0,
excessPayment: 0
});
}

const site = sites.find(site => site.siteNo === siteNo);

if (invoiceType === 'payment') {
site.excessPayment += invoiceBalance;
} else {
site.outstanding += invoiceBalance;
}
}
});

if (sites.length === 0) {
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No sites found for New VO: <strong>${newVO}</strong></div>`;
return;
}

let html = `<div class="section-title"><i class="fas fa-user-tie"></i> Sites for ${newVO}</div>
<table>
<thead>
<tr>
<th>Site No</th>
<th>Site Name</th>
<th>Customer Name</th>
<th>Outstanding (Rs.)</th>
<th>Excess Payment (Rs.)</th>
<th>Net Outstanding (Rs.)</th>
</tr>
</thead>
<tbody>`;

let totalOutstanding = 0;
let totalExcess = 0;
let totalNet = 0;

sites.forEach(site => {
const netOutstanding = site.outstanding + site.excessPayment;
const excessDisplay = site.excessPayment < 0
? `(${formatAmount(Math.abs(site.excessPayment))})`
: formatAmount(site.excessPayment);
const excessClass = site.excessPayment < 0 ? 'amount payment' : 'amount';

totalOutstanding += site.outstanding;
totalExcess += site.excessPayment;
totalNet += netOutstanding;

html += `<tr>
<td><a class="site-link" onclick="searchBySiteNo('${site.siteNo}')">${site.siteNo}</a></td>
<td>${site.siteName}</td>
<td>${site.customerName}</td>
<td class="amount">${formatAmount(site.outstanding)}</td>
<td class="${excessClass}">${excessDisplay}</td>
<td class="amount" style="font-weight: 700;">${formatAmount(netOutstanding)}</td>
</tr>`;
});

const totalExcessDisplay = totalExcess < 0
? `(${formatAmount(Math.abs(totalExcess))})`
: formatAmount(totalExcess);

html += `<tr class="total-row">
<td style="text-align: right;">TOTAL</td>
<td></td>
<td></td>
<td class="amount">${formatAmount(totalOutstanding)}</td>
<td class="amount payment">${totalExcessDisplay}</td>
<td class="amount">${formatAmount(totalNet)}</td>
</tr>`;

html += `</tbody></table>`;

html += `<div class="summary-totals">
<div class="summary-card">
<h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
<div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-map-marker-alt"></i> Total Sites</h3>
<div class="amount-big">${sites.length}</div>
</div>
</div>`;

html += `<div style="text-align: center;">
<button class="go-back-btn" onclick="goBack()">
<i class="fas fa-arrow-left"></i> Go Back
</button>
</div>`;

resultsDiv.innerHTML = html;
}

// Function to show sites for a SM
async function showSMSites(sm) {
const resultsDiv = document.getElementById('results');
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading sites for ${sm}...</div>`;

const rows = await fetchSheetData();
const sites = [];

rows.forEach(row => {
const rowSM = row.c[5]?.v?.toString() || '';
const customerName = row.c[0]?.v?.toString() || '';
const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
const siteName = row.c[2]?.v?.toString() || '';
const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
const invoiceBalance = row.c[11]?.v || 0;

if (rowSM === sm && siteNo) {
const existingSite = sites.find(site => site.siteNo === siteNo);

if (!existingSite) {
sites.push({
siteNo,
siteName,
customerName,
outstanding: 0,
excessPayment: 0
});
}

const site = sites.find(site => site.siteNo === siteNo);

if (invoiceType === 'payment') {
site.excessPayment += invoiceBalance;
} else {
site.outstanding += invoiceBalance;
}
}
});

if (sites.length === 0) {
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No sites found for SM: <strong>${sm}</strong></div>`;
return;
}

let html = `<div class="section-title"><i class="fas fa-user-check"></i> Sites for ${sm}</div>
<table>
<thead>
<tr>
<th>Site No</th>
<th>Site Name</th>
<th>Customer Name</th>
<th>Outstanding (Rs.)</th>
<th>Excess Payment (Rs.)</th>
<th>Net Outstanding (Rs.)</th>
</tr>
</thead>
<tbody>`;

let totalOutstanding = 0;
let totalExcess = 0;
let totalNet = 0;

sites.forEach(site => {
const netOutstanding = site.outstanding + site.excessPayment;
const excessDisplay = site.excessPayment < 0
? `(${formatAmount(Math.abs(site.excessPayment))})`
: formatAmount(site.excessPayment);
const excessClass = site.excessPayment < 0 ? 'amount payment' : 'amount';

totalOutstanding += site.outstanding;
totalExcess += site.excessPayment;
totalNet += netOutstanding;

html += `<tr>
<td><a class="site-link" onclick="searchBySiteNo('${site.siteNo}')">${site.siteNo}</a></td>
<td>${site.siteName}</td>
<td>${site.customerName}</td>
<td class="amount">${formatAmount(site.outstanding)}</td>
<td class="${excessClass}">${excessDisplay}</td>
<td class="amount" style="font-weight: 700;">${formatAmount(netOutstanding)}</td>
</tr>`;
});

const totalExcessDisplay = totalExcess < 0
? `(${formatAmount(Math.abs(totalExcess))})`
: formatAmount(totalExcess);

html += `<tr class="total-row">
<td style="text-align: right;">TOTAL</td>
<td></td>
<td></td>
<td class="amount">${formatAmount(totalOutstanding)}</td>
<td class="amount payment">${totalExcessDisplay}</td>
<td class="amount">${formatAmount(totalNet)}</td>
</tr>`;

html += `</tbody></table>`;

html += `<div class="summary-totals">
<div class="summary-card">
<h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
<div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-map-marker-alt"></i> Total Sites</h3>
<div class="amount-big">${sites.length}</div>
</div>
</div>`;

html += `<div style="text-align: center;">
<button class="go-back-btn" onclick="goBack()">
<i class="fas fa-arrow-left"></i> Go Back
</button>
</div>`;

resultsDiv.innerHTML = html;
}

// Function to show sites for an OM
async function showOMSites(om) {
const resultsDiv = document.getElementById('results');
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading sites for ${om}...</div>`;

const rows = await fetchSheetData();
const sites = [];

rows.forEach(row => {
const rowOM = row.c[6]?.v?.toString() || '';
const customerName = row.c[0]?.v?.toString() || '';
const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
const siteName = row.c[2]?.v?.toString() || '';
const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
const invoiceBalance = row.c[11]?.v || 0;

if (rowOM === om && siteNo) {
const existingSite = sites.find(site => site.siteNo === siteNo);

if (!existingSite) {
sites.push({
siteNo,
siteName,
customerName,
outstanding: 0,
excessPayment: 0
});
}

const site = sites.find(site => site.siteNo === siteNo);

if (invoiceType === 'payment') {
site.excessPayment += invoiceBalance;
} else {
site.outstanding += invoiceBalance;
}
}
});

if (sites.length === 0) {
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No sites found for OM: <strong>${om}</strong></div>`;
return;
}

let html = `<div class="section-title"><i class="fas fa-user-shield"></i> Sites for ${om}</div>
<table>
<thead>
<tr>
<th>Site No</th>
<th>Site Name</th>
<th>Customer Name</th>
<th>Outstanding (Rs.)</th>
<th>Excess Payment (Rs.)</th>
<th>Net Outstanding (Rs.)</th>
</tr>
</thead>
<tbody>`;

let totalOutstanding = 0;
let totalExcess = 0;
let totalNet = 0;

sites.forEach(site => {
const netOutstanding = site.outstanding + site.excessPayment;
const excessDisplay = site.excessPayment < 0
? `(${formatAmount(Math.abs(site.excessPayment))})`
: formatAmount(site.excessPayment);
const excessClass = site.excessPayment < 0 ? 'amount payment' : 'amount';

totalOutstanding += site.outstanding;
totalExcess += site.excessPayment;
totalNet += netOutstanding;

html += `<tr>
<td><a class="site-link" onclick="searchBySiteNo('${site.siteNo}')">${site.siteNo}</a></td>
<td>${site.siteName}</td>
<td>${site.customerName}</td>
<td class="amount">${formatAmount(site.outstanding)}</td>
<td class="${excessClass}">${excessDisplay}</td>
<td class="amount" style="font-weight: 700;">${formatAmount(netOutstanding)}</td>
</tr>`;
});

const totalExcessDisplay = totalExcess < 0
? `(${formatAmount(Math.abs(totalExcess))})`
: formatAmount(totalExcess);

html += `<tr class="total-row">
<td style="text-align: right;">TOTAL</td>
<td></td>
<td></td>
<td class="amount">${formatAmount(totalOutstanding)}</td>
<td class="amount payment">${totalExcessDisplay}</td>
<td class="amount">${formatAmount(totalNet)}</td>
</tr>`;

html += `</tbody></table>`;

html += `<div class="summary-totals">
<div class="summary-card">
<h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
<div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-map-marker-alt"></i> Total Sites</h3>
<div class="amount-big">${sites.length}</div>
</div>
</div>`;

html += `<div style="text-align: center;">
<button class="go-back-btn" onclick="goBack()">
<i class="fas fa-arrow-left"></i> Go Back
</button>
</div>`;

resultsDiv.innerHTML = html;
}

// Function to show sites for a Collector
async function showCollectorSites(collector) {
const resultsDiv = document.getElementById('results');
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-spinner fa-spin"></i> Loading sites for ${collector}...</div>`;

const rows = await fetchSheetData();
const sites = [];

rows.forEach(row => {
const rowCollector = row.c[7]?.v?.toString() || '';
const customerName = row.c[0]?.v?.toString() || '';
const siteNo = row.c[1]?.v?.toString().toUpperCase() || '';
const siteName = row.c[2]?.v?.toString() || '';
const invoiceType = row.c[10]?.v?.toString().toLowerCase() || '';
const invoiceBalance = row.c[11]?.v || 0;

if (rowCollector === collector && siteNo) {
const existingSite = sites.find(site => site.siteNo === siteNo);

if (!existingSite) {
sites.push({
siteNo,
siteName,
customerName,
outstanding: 0,
excessPayment: 0
});
}

const site = sites.find(site => site.siteNo === siteNo);

if (invoiceType === 'payment') {
site.excessPayment += invoiceBalance;
} else {
site.outstanding += invoiceBalance;
}
}
});

if (sites.length === 0) {
resultsDiv.innerHTML = `<div class="not-found"><i class="fas fa-exclamation-circle"></i> No sites found for Collector: <strong>${collector}</strong></div>`;
return;
}

let html = `<div class="section-title"><i class="fas fa-user-cog"></i> Sites for ${collector}</div>
<table>
<thead>
<tr>
<th>Site No</th>
<th>Site Name</th>
<th>Customer Name</th>
<th>Outstanding (Rs.)</th>
<th>Excess Payment (Rs.)</th>
<th>Net Outstanding (Rs.)</th>
</tr>
</thead>
<tbody>`;

let totalOutstanding = 0;
let totalExcess = 0;
let totalNet = 0;

sites.forEach(site => {
const netOutstanding = site.outstanding + site.excessPayment;
const excessDisplay = site.excessPayment < 0
? `(${formatAmount(Math.abs(site.excessPayment))})`
: formatAmount(site.excessPayment);
const excessClass = site.excessPayment < 0 ? 'amount payment' : 'amount';

totalOutstanding += site.outstanding;
totalExcess += site.excessPayment;
totalNet += netOutstanding;

html += `<tr>
<td><a class="site-link" onclick="searchBySiteNo('${site.siteNo}')">${site.siteNo}</a></td>
<td>${site.siteName}</td>
<td>${site.customerName}</td>
<td class="amount">${formatAmount(site.outstanding)}</td>
<td class="${excessClass}">${excessDisplay}</td>
<td class="amount" style="font-weight: 700;">${formatAmount(netOutstanding)}</td>
</tr>`;
});

const totalExcessDisplay = totalExcess < 0
? `(${formatAmount(Math.abs(totalExcess))})`
: formatAmount(totalExcess);

html += `<tr class="total-row">
<td style="text-align: right;">TOTAL</td>
<td></td>
<td></td>
<td class="amount">${formatAmount(totalOutstanding)}</td>
<td class="amount payment">${totalExcessDisplay}</td>
<td class="amount">${formatAmount(totalNet)}</td>
</tr>`;

html += `</tbody></table>`;

html += `<div class="summary-totals">
<div class="summary-card">
<h3><i class="fas fa-file-invoice"></i> Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalOutstanding)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-hand-holding-usd"></i> Total Excess Payments</h3>
<div class="amount-big" style="color: #38a169;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-chart-line"></i> Net Total Outstanding</h3>
<div class="amount-big">Rs. ${formatAmount(totalNet)}</div>
</div>
<div class="summary-card">
<h3><i class="fas fa-map-marker-alt"></i> Total Sites</h3>
<div class="amount-big">${sites.length}</div>
</div>
</div>`;

html += `<div style="text-align: center;">
<button class="go-back-btn" onclick="goBack()">
<i class="fas fa-arrow-left"></i> Go Back
</button>
</div>`;

resultsDiv.innerHTML = html;
}

// Function to navigate back to previous view
function goBack() {
// If navigation history has items, go back to previous state
if (navigationHistory.length > 1) {
// Remove current state from history
navigationHistory.pop();

// Get previous state
const previousState = navigationHistory[navigationHistory.length - 1];

// Restore previous state
currentSortType = previousState.sortType;
currentView = previousState.view;

// Re-render previous view with its data and sort type
if (previousState.view === 'summary') {
renderCustomerSummary(previousState.data);
} else if (previousState.view === 'newVO') {
renderNewVOSummary(previousState.data);
} else if (previousState.view === 'sm') {
renderSMSummary(previousState.data);
} else if (previousState.view === 'om') {
renderOMSummary(previousState.data);
} else if (previousState.view === 'collector') {
renderCollectorSummary(previousState.data);
} else if (previousState.view === 'ageAnalysis') {
renderAgeAnalysis(previousState.data);
} else if (previousState.view === 'ageFilter') {
currentAgeFilter = previousState.ageRange;
renderInvoicesByAge(previousState.data, previousState.ageRange);
}
} else {
// If no history, clear results and return to main menu
document.getElementById('results').innerHTML = '';
currentView = null;
previousView = null;
navigationHistory = [];
currentAgeFilter = null;

// Hide age filter container when going back to main menu
document.getElementById('ageFilterContainer').classList.remove('show');
const button = document.querySelector('.search-box:nth-child(9) button');
button.innerHTML = '<i class="fas fa-filter"></i> Show Age Filter Options';
}
}
  </script>

</body>
</html>